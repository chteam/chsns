# Feature Specification: 通用评论系统

**Feature Branch**: `008-comment-system`  
**Created**: 2025-11-14  
**Status**: Draft  
**Input**: 通用评论系统：支持多种对象评论（博客、照片、动态等）、嵌套回复、评论点赞、评论举报、评论排序、评论分页、评论通知、评论审核

## User Scenarios & Testing *(mandatory)*

### User Story 1 - 发表评论 (Priority: P1)

用户可以对各种对象（博客、照片、动态、视频等）发表评论，表达观点和反馈。

**Why this priority**: 评论是社交互动的核心功能，让用户可以参与讨论和表达意见。

**Independent Test**: 用户在博客详情页输入评论"写得很好！"并发表，验证评论显示在博客下方。

**Acceptance Scenarios**:

1. **Given** 用户查看博客, **When** 在评论框输入内容并点击"发表", **Then** 评论立即显示在评论列表中
2. **Given** 用户发表评论, **When** 评论内容为空, **Then** 系统提示"评论内容不能为空"
3. **Given** 用户发表评论, **When** 评论内容超过 1000 字符, **Then** 系统提示"评论过长"
4. **Given** 用户发表评论, **When** 评论包含敏感词, **Then** 系统标记为待审核或自动过滤
5. **Given** 用户发表评论成功, **When** 内容作者查看, **Then** 作者收到评论通知
6. **Given** 用户短时间内连续发表多条评论, **When** 超过速率限制, **Then** 系统提示"评论过于频繁"

---

### User Story 2 - 嵌套回复 (Priority: P1)

用户可以回复其他人的评论，形成嵌套对话，方便追踪讨论上下文。

**Why this priority**: 嵌套回复让讨论更有条理，用户可以直接回应特定评论。

**Independent Test**: 用户点击评论下的"回复"按钮，输入"同意你的观点"，验证回复显示在该评论下方。

**Acceptance Scenarios**:

1. **Given** 用户查看评论, **When** 点击"回复"按钮, **Then** 评论框自动 @ 被回复用户
2. **Given** 用户回复评论, **When** 输入内容并发表, **Then** 回复显示在原评论下方（缩进显示）
3. **Given** 用户查看嵌套回复, **When** 回复层级超过 3 层, **Then** 系统限制最多 3 层嵌套（避免过深）
4. **Given** 用户回复评论, **When** 原评论被删除, **Then** 回复也应被删除或标记为"原评论已删除"
5. **Given** 被回复用户, **When** 收到新回复, **Then** 收到"@你"的通知

---

### User Story 3 - 评论点赞 (Priority: P2)

用户可以对评论点赞，表达认可。点赞数量可以影响评论排序（如热门优先）。

**Why this priority**: 点赞是快速反馈机制，帮助识别高质量评论。

**Independent Test**: 用户点击评论的"点赞"按钮，验证点赞数量 +1，再次点击取消点赞。

**Acceptance Scenarios**:

1. **Given** 用户查看评论, **When** 点击"点赞"按钮, **Then** 点赞数量 +1 且按钮变为"已点赞"状态
2. **Given** 用户已点赞评论, **When** 再次点击"取消点赞", **Then** 点赞数量 -1 且按钮恢复为"点赞"
3. **Given** 多个用户点赞同一评论, **When** 查看点赞列表, **Then** 显示所有点赞用户
4. **Given** 用户点赞自己的评论, **When** 系统处理, **Then** 允许但可能提示"你点赞了自己的评论"
5. **Given** 评论按"热门排序", **When** 点赞数高的评论, **Then** 排在前面

---

### User Story 4 - 评论举报 (Priority: P2)

用户可以举报不当评论（如垃圾信息、辱骂、广告等），管理员可以审核处理。

**Why this priority**: 举报机制维护社区健康，让用户参与内容治理。

**Independent Test**: 用户点击评论的"举报"按钮，选择举报原因"垃圾广告"，验证举报提交成功。

**Acceptance Scenarios**:

1. **Given** 用户查看评论, **When** 点击"举报"按钮, **Then** 打开举报对话框
2. **Given** 用户选择举报原因, **When** 提交举报, **Then** 系统记录举报并通知管理员
3. **Given** 管理员查看举报列表, **When** 查看举报详情, **Then** 显示举报原因、举报人、评论内容
4. **Given** 管理员审核举报, **When** 确认违规, **Then** 删除评论并可能警告或封禁用户
5. **Given** 管理员审核举报, **When** 认为不违规, **Then** 驳回举报并保留评论
6. **Given** 用户恶意举报, **When** 系统检测到, **Then** 限制该用户的举报权限

---

### User Story 5 - 评论排序 (Priority: P1)

用户可以选择评论排序方式（最新优先、最早优先、热门优先），满足不同浏览需求。

**Why this priority**: 灵活的排序方式提升用户体验，适应不同阅读习惯。

**Independent Test**: 用户在评论列表切换排序为"热门优先"，验证点赞数多的评论排在前面。

**Acceptance Scenarios**:

1. **Given** 用户查看评论列表, **When** 默认加载, **Then** 按"最新优先"排序（最新的在最前）
2. **Given** 用户切换排序, **When** 选择"最早优先", **Then** 评论按发表时间正序排列
3. **Given** 用户切换排序, **When** 选择"热门优先", **Then** 评论按点赞数倒序排列
4. **Given** 用户切换排序, **When** 刷新页面, **Then** 保持用户选择的排序方式（Cookie/LocalStorage）
5. **Given** 评论按热门排序, **When** 多条评论点赞数相同, **Then** 按发表时间排序（最新的在前）

---

### User Story 6 - 评论分页 (Priority: P1)

评论列表支持分页或无限滚动，避免一次加载过多数据影响性能。

**Why this priority**: 分页优化性能和用户体验，特别是评论数量较多时。

**Independent Test**: 博客有 100 条评论，用户打开页面验证默认显示 20 条，滚动到底部自动加载更多。

**Acceptance Scenarios**:

1. **Given** 评论列表有 100+ 条评论, **When** 页面加载, **Then** 默认显示前 20 条
2. **Given** 用户查看评论, **When** 滚动到列表底部, **Then** 自动加载下一页（无限滚动）
3. **Given** 用户查看评论, **When** 点击"加载更多"按钮, **Then** 加载下一页评论（分页模式）
4. **Given** 用户查看评论, **When** 加载完所有评论, **Then** 显示"已加载全部评论"提示
5. **Given** 用户发表新评论, **When** 评论成功, **Then** 新评论插入到列表顶部（最新优先）或底部（最早优先）

---

### User Story 7 - 评论通知 (Priority: P2)

用户收到评论通知（他人评论了我的内容、回复了我的评论），及时了解互动。

**Why this priority**: 通知增强用户参与感，促进互动和回访。

**Independent Test**: 用户 A 评论了 B 的博客，B 登录后在通知中心看到"A 评论了你的博客"。

**Acceptance Scenarios**:

1. **Given** 用户 B 发布博客, **When** 用户 A 评论, **Then** B 收到"A 评论了你的博客《标题》"通知
2. **Given** 用户 B 发表评论, **When** 用户 A 回复 B 的评论, **Then** B 收到"A 回复了你的评论"通知
3. **Given** 用户收到评论通知, **When** 点击通知, **Then** 跳转到对应的内容页面并高亮显示评论
4. **Given** 用户收到多条评论通知, **When** 查看通知列表, **Then** 显示未读数量和通知内容摘要
5. **Given** 用户设置通知偏好, **When** 关闭评论通知, **Then** 系统不再发送评论相关通知

---

### User Story 8 - 评论审核 (Priority: P3)

管理员可以审核评论，删除违规内容，维护社区秩序。支持自动审核和人工审核。

**Why this priority**: 审核机制保证内容质量，防止垃圾信息和违规内容传播。

**Independent Test**: 管理员在后台查看待审核评论列表，批准或删除评论。

**Acceptance Scenarios**:

1. **Given** 系统启用自动审核, **When** 评论包含敏感词, **Then** 评论标记为待审核状态（不立即显示）
2. **Given** 管理员查看待审核列表, **When** 点击"批准", **Then** 评论变为公开状态
3. **Given** 管理员查看待审核列表, **When** 点击"删除", **Then** 评论被删除且不显示
4. **Given** 管理员查看评论, **When** 直接删除已发布的评论, **Then** 评论从列表中移除
5. **Given** 系统检测到垃圾评论, **When** 用户多次发表相似内容, **Then** 自动标记为垃圾评论

---

### Edge Cases

- **评论对象删除**: 博客被删除后，评论是否级联删除或保留（归档）
- **评论作者删除**: 用户注销账户后，评论是否保留（显示为"已注销用户"）
- **评论编辑**: 用户是否可以编辑已发表的评论（记录编辑历史）
- **评论@提及**: 评论中 @其他用户，被提及用户是否收到通知
- **评论敏感词**: 评论包含敏感词但不完全匹配，如何处理（模糊匹配）
- **评论表情符号**: 评论是否支持 Emoji 表情
- **评论长度**: 评论超长时是否截断显示（"展开查看更多"）
- **并发评论**: 多个用户同时评论同一内容，评论顺序如何保证

## Requirements *(mandatory)*

### Functional Requirements

#### 评论发表
- **FR-001**: 用户 MUST 能够对支持的对象类型发表评论（博客、照片、动态、视频等）
- **FR-002**: 评论 MUST 包含以下字段：评论内容、评论用户、评论对象类型、评论对象 ID、发表时间
- **FR-003**: 评论内容 MUST 限制在 1000 字符以内
- **FR-004**: 评论内容 MUST 不能为空
- **FR-005**: 系统 MUST 实施评论速率限制：每分钟最多 10 条，每天最多 200 条
- **FR-006**: 评论 MUST 支持文本格式（纯文本，支持 Emoji）
- **FR-007**: 评论发表后 MUST 立即显示在评论列表中（或待审核状态）

#### 嵌套回复
- **FR-008**: 用户 MUST 能够回复其他人的评论
- **FR-009**: 回复评论时 MUST 自动 @ 被回复用户（显示"@用户名: 回复内容"）
- **FR-010**: 嵌套回复 MUST 限制最大层级为 3 层（避免过深嵌套）
- **FR-011**: 回复 MUST 显示在原评论下方（缩进或嵌套显示）
- **FR-012**: 系统 MUST 记录回复的父评论 ID（ReplyToId）

#### 评论删除
- **FR-013**: 用户 MUST 能够删除自己的评论
- **FR-014**: 内容作者 MUST 能够删除自己内容下的任何评论
- **FR-015**: 管理员 MUST 能够删除任何评论
- **FR-016**: 删除评论时 MUST 同时删除该评论的所有回复（级联删除）或标记为"评论已删除"
- **FR-017**: 删除评论 MUST 需要确认（防止误删）

#### 评论点赞
- **FR-018**: 用户 MUST 能够对评论点赞
- **FR-019**: 用户 MUST 能够取消点赞
- **FR-020**: 系统 MUST 实时更新点赞数量
- **FR-021**: 系统 MUST 记录点赞用户列表
- **FR-022**: 用户 MUST 能够查看点赞用户列表

#### 评论举报
- **FR-023**: 用户 MUST 能够举报不当评论
- **FR-024**: 举报 MUST 包含举报原因（垃圾信息、辱骂、广告、色情、违法等）
- **FR-025**: 系统 MUST 记录举报详情（举报人、举报时间、举报原因）
- **FR-026**: 管理员 MUST 能够查看举报列表
- **FR-027**: 管理员 MUST 能够处理举报（批准删除、驳回举报）
- **FR-028**: 系统 SHOULD 检测恶意举报并限制举报权限

#### 评论排序
- **FR-029**: 评论列表 MUST 支持三种排序方式：最新优先（CreateTime DESC）、最早优先（CreateTime ASC）、热门优先（LikeCount DESC）
- **FR-030**: 默认排序 MUST 为"最新优先"
- **FR-031**: 用户切换排序后 SHOULD 保存偏好（Cookie/LocalStorage）
- **FR-032**: 热门排序时点赞数相同的评论 MUST 按时间排序

#### 评论分页
- **FR-033**: 评论列表 MUST 支持分页，每页显示 20 条评论
- **FR-034**: 评论列表 SHOULD 支持无限滚动（自动加载下一页）
- **FR-035**: 加载完所有评论后 MUST 显示"已加载全部评论"提示
- **FR-036**: 新发表的评论 MUST 根据当前排序方式插入到正确位置

#### 评论通知
- **FR-037**: 系统 MUST 在用户收到评论时发送通知（内容被评论、评论被回复）
- **FR-038**: 通知 MUST 包含评论人、评论内容摘要、评论对象
- **FR-039**: 用户 MUST 能够点击通知跳转到对应内容并高亮评论
- **FR-040**: 用户 SHOULD 能够设置通知偏好（开启/关闭评论通知）

#### 评论审核
- **FR-041**: 系统 SHOULD 支持评论审核功能（可配置开启/关闭）
- **FR-042**: 系统 SHOULD 检测评论中的敏感词并标记为待审核
- **FR-043**: 待审核评论 MUST 不对外显示，仅管理员可见
- **FR-044**: 管理员 MUST 能够批准或删除待审核评论
- **FR-045**: 系统 SHOULD 支持自动审核规则（如黑名单关键词、垃圾评论检测）

#### 通用支持
- **FR-046**: 评论系统 MUST 支持多种对象类型（通过 ObjectType 和 ObjectId 关联）
- **FR-047**: 评论系统 MUST 支持以下对象类型：博客（Blog）、照片（Photo）、动态（Event）、视频（Video）
- **FR-048**: 系统 MUST 统计对象的评论总数（冗余字段，性能优化）
- **FR-049**: 评论 SHOULD 支持 Emoji 表情符号
- **FR-050**: 评论 SHOULD 支持 @ 提及其他用户（可选扩展功能）

### Key Entities

#### Comment (评论实体 - 通用)
- **Id** (long, 主键): 评论 ID
- **ObjectType** (enum/string): 评论对象类型（Blog, Photo, Event, Video 等）
- **ObjectId** (long): 评论对象 ID
- **UserId** (long, 外键): 评论用户 ID
- **Content** (string, 1000字符): 评论内容
- **ReplyToId** (long, 可选): 回复的评论 ID（嵌套回复）
- **ReplyToUserId** (long, 可选): 回复的用户 ID
- **Status** (enum): 评论状态（Published=0, Pending=1, Deleted=2）
- **CreateTime** (DateTime): 发表时间
- **LikeCount** (int): 点赞数量（冗余字段）
- **ReplyCount** (int): 回复数量（冗余字段）
- **索引**: (ObjectType, ObjectId, CreateTime) 用于评论列表查询
- **索引**: (UserId, CreateTime) 用于用户评论查询
- **索引**: (ReplyToId) 用于嵌套回复查询

#### CommentLike (评论点赞实体)
- **Id** (long, 主键): 点赞 ID
- **CommentId** (long, 外键): 评论 ID
- **UserId** (long, 外键): 点赞用户 ID
- **CreateTime** (DateTime): 点赞时间
- **唯一索引**: (CommentId, UserId) 防止重复点赞

#### CommentReport (评论举报实体)
- **Id** (long, 主键): 举报 ID
- **CommentId** (long, 外键): 被举报的评论 ID
- **ReporterId** (long, 外键): 举报人用户 ID
- **Reason** (enum/string): 举报原因（Spam=0, Abuse=1, Ad=2, Porn=3, Illegal=4, Other=5）
- **Description** (string, 500字符, 可选): 举报详细说明
- **Status** (enum): 处理状态（Pending=0, Approved=1, Rejected=2）
- **CreateTime** (DateTime): 举报时间
- **HandleTime** (DateTime, 可选): 处理时间
- **HandlerId** (long, 可选): 处理管理员 ID
- **索引**: (Status, CreateTime) 用于待处理举报查询

## Success Criteria *(mandatory)*

### Measurable Outcomes

- **SC-001**: 评论发表响应时间 < 500 毫秒
- **SC-002**: 评论列表加载时间 < 1 秒（100 条评论）
- **SC-003**: 评论点赞操作响应时间 < 300 毫秒
- **SC-004**: 系统支持 1000 个并发用户发表评论不出现性能问题
- **SC-005**: 评论审核准确率 > 95%（敏感词检测）
- **SC-006**: 评论通知送达率 > 99%
- **SC-007**: 用户评论参与率 > 20%（至少 20% 的内容有评论）
- **SC-008**: 评论举报处理时效 < 24 小时
- **SC-009**: 嵌套回复层级不超过 3 层（100% 遵守）
- **SC-010**: 评论删除后级联删除回复成功率 100%

## Assumptions *(optional)*

### Technical Assumptions
- 评论内容存储在数据库文本字段中
- 评论排序使用数据库索引优化
- 评论通知通过消息队列异步发送
- 敏感词检测使用关键词匹配或第三方 API
- 评论对象类型使用枚举或字符串标识

### Business Assumptions
- 用户平均每天发表 3-5 条评论
- 大部分评论是一级评论（非回复）
- 评论点赞率约 10%（10% 的评论被点赞）
- 评论举报率 < 1%（大部分评论是正常的）
- 评论审核主要依靠自动检测，少量人工介入

### User Experience Assumptions
- 用户期望评论立即显示（实时反馈）
- 用户希望看到评论按最新或热门排序
- 用户希望收到评论通知
- 用户希望评论支持嵌套回复（跟踪讨论）

## Dependencies *(optional)*

### Internal Dependencies
- **用户认证与授权系统 (#001)**: 提供用户身份验证
- **用户资料系统 (#002)**: 提供用户头像和用户名
- **博客系统 (#006)**: 提供博客评论对象
- **相册/照片系统 (#007)**: 提供照片评论对象
- **活动动态系统 (#005)**: 提供动态评论对象
- 通知系统（未来）: 集成评论通知

### External Dependencies
- **敏感词检测服务**: 第三方 API 或自建关键词库
- **垃圾评论检测**: Akismet API 或机器学习模型
- **消息队列**: RabbitMQ, Kafka 用于异步通知

## Out of Scope *(optional)*

以下功能**不在**本次规格范围内：

- 评论编辑功能（发表后修改评论） - 属于扩展功能
- 评论投票（赞同/反对） - 属于高级互动功能
- 评论奖励机制（积分、徽章） - 属于激励系统
- 评论 AI 分析（情感分析、摘要） - 属于 AI 功能
- 评论导出功能 - 属于工具功能
- 评论翻译功能（多语言） - 属于国际化功能
- 评论富文本支持（加粗、链接） - 属于编辑器增强
- 评论@ 提及（自动补全用户名） - 属于高级功能（可选）

## Notes *(optional)*

### Security Considerations
- 评论内容必须防止 XSS 攻击（HTML 转义）
- 敏感词检测防止违规内容传播
- 速率限制防止垃圾评论和刷屏
- 举报功能防止恶意举报（记录举报历史）

### Performance Considerations
- 评论列表查询使用复合索引（ObjectType, ObjectId, CreateTime）
- 评论数量使用冗余字段（实时更新或定时同步）
- 点赞数量使用冗余字段（异步更新）
- 评论分页减少数据传输量
- 评论通知使用消息队列异步发送

### Scalability Considerations
- 评论表按对象类型或时间分表
- 热门内容的评论可以单独缓存
- 评论通知使用分布式消息队列
- 评论审核使用任务队列处理

### User Experience Considerations
- 评论发表提供即时反馈（乐观更新）
- 评论回复自动 @ 被回复用户
- 评论通知跳转到对应内容并高亮
- 评论排序切换保持用户偏好
- 评论加载使用无限滚动（移动端友好）

### Open Questions for Future Iterations
- 是否需要支持评论编辑功能（记录编辑历史）？
- 是否需要支持评论投票（赞同/反对）？
- 是否需要评论@ 提及功能（自动补全）？
- 是否需要评论富文本支持（加粗、链接）？
- 是否需要评论 AI 分析（情感分析、摘要）？
- 评论删除是物理删除还是逻辑删除（软删除）？
