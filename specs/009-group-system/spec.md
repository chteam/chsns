# Feature Specification: 群组系统

**Feature Branch**: `009-group-system`  
**Created**: 2025-11-14  
**Status**: Draft  
**Input**: 群组系统：创建群组、加入退出群组、群组角色权限（组长管理员成员）、群组公告、群组成员管理、群组讨论（帖子）、群组隐私设置、群组搜索

## User Scenarios & Testing *(mandatory)*

### User Story 1 - 创建和管理群组 (Priority: P1)

用户可以创建群组，设置群组名称、简介、头像，并作为群组组长管理群组。

**Why this priority**: 群组是兴趣社区的基础，用户需要创建和管理自己的群组。

**Independent Test**: 用户点击"创建群组"按钮，输入群组名称"前端开发交流"，保存后在群组列表看到该群组。

**Acceptance Scenarios**:

1. **Given** 用户在群组页面, **When** 点击"创建群组", **Then** 打开群组创建表单
2. **Given** 用户填写群组名称和简介, **When** 点击"保存", **Then** 群组创建成功并自动成为组长
3. **Given** 用户创建群组, **When** 群组名称为空, **Then** 系统提示"群组名称不能为空"
4. **Given** 用户创建群组, **When** 群组名称超过 50 字符, **Then** 系统提示"群组名称过长"
5. **Given** 用户是群组组长, **When** 编辑群组信息, **Then** 可以修改群组名称、简介、头像
6. **Given** 用户是群组组长, **When** 点击"解散群组", **Then** 系统提示确认并删除群组及所有内容
7. **Given** 用户解散群组, **When** 群组有成员, **Then** 系统提示"群组有 N 名成员，确认解散？"

---

### User Story 2 - 加入和退出群组 (Priority: P1)

用户可以加入公开或需要审核的群组，也可以随时退出群组。

**Why this priority**: 用户需要加入感兴趣的群组参与讨论，也需要退出不感兴趣的群组。

**Independent Test**: 用户在群组列表点击"加入群组"，验证加入成功并在"我的群组"列表中看到该群组。

**Acceptance Scenarios**:

1. **Given** 用户查看公开群组, **When** 点击"加入群组", **Then** 立即加入并成为群组成员
2. **Given** 用户加入需要审核的群组, **When** 点击"申请加入", **Then** 提交申请并等待管理员审核
3. **Given** 管理员查看加入申请, **When** 批准申请, **Then** 用户成为群组成员并收到通知
4. **Given** 管理员查看加入申请, **When** 拒绝申请, **Then** 用户收到"申请被拒绝"通知
5. **Given** 用户是群组成员, **When** 点击"退出群组", **Then** 系统提示确认并退出群组
6. **Given** 用户退出群组, **When** 确认退出, **Then** 从群组成员列表中移除
7. **Given** 用户是群组组长, **When** 尝试退出群组, **Then** 系统提示"请先转让组长或解散群组"

---

### User Story 3 - 群组角色和权限 (Priority: P1)

群组有三种角色：组长、管理员、普通成员。不同角色有不同的权限。

**Why this priority**: 权限管理是群组治理的核心，保证群组秩序和安全。

**Independent Test**: 组长将用户 A 设置为管理员，验证 A 获得管理权限（如删除帖子、移除成员）。

**Acceptance Scenarios**:

1. **Given** 用户是群组组长, **When** 查看成员列表, **Then** 可以设置成员为管理员或移除管理员身份
2. **Given** 用户是管理员, **When** 查看群组, **Then** 可以编辑群组信息、删除帖子、移除成员
3. **Given** 用户是普通成员, **When** 查看群组, **Then** 仅可以发帖、评论，不能管理群组
4. **Given** 用户是组长, **When** 转让组长给其他成员, **Then** 新组长获得所有权限，原组长变为普通成员
5. **Given** 用户是管理员, **When** 尝试解散群组, **Then** 系统拒绝（仅组长可以解散）
6. **Given** 用户是组长, **When** 移除管理员身份, **Then** 该用户变为普通成员

---

### User Story 4 - 群组公告 (Priority: P2)

组长和管理员可以发布群组公告，公告置顶显示在群组页面顶部。

**Why this priority**: 公告用于发布重要通知，让所有成员及时了解群组动态。

**Independent Test**: 管理员发布公告"本周六线下聚会"，验证公告显示在群组页面顶部。

**Acceptance Scenarios**:

1. **Given** 用户是组长或管理员, **When** 点击"发布公告", **Then** 打开公告编辑表单
2. **Given** 用户编辑公告, **When** 输入标题和内容并保存, **Then** 公告发布并置顶显示
3. **Given** 用户查看群组, **When** 有公告, **Then** 公告显示在页面顶部（高亮或横幅样式）
4. **Given** 用户是普通成员, **When** 尝试发布公告, **Then** 系统拒绝（无权限）
5. **Given** 用户是管理员, **When** 编辑或删除公告, **Then** 公告更新或移除
6. **Given** 群组有多条公告, **When** 查看, **Then** 显示最新的公告（或支持多条公告列表）

---

### User Story 5 - 群组成员管理 (Priority: P1)

组长和管理员可以查看成员列表，移除成员，设置成员角色。

**Why this priority**: 成员管理是维护群组秩序的基础功能。

**Independent Test**: 管理员在成员列表中移除违规用户，验证该用户被移出群组。

**Acceptance Scenarios**:

1. **Given** 用户是组长或管理员, **When** 查看成员列表, **Then** 显示所有成员及其角色
2. **Given** 用户是管理员, **When** 点击"移除成员", **Then** 系统提示确认并移除该用户
3. **Given** 用户被移除, **When** 尝试访问群组, **Then** 系统提示"你已不是该群组成员"
4. **Given** 用户是组长, **When** 设置成员为管理员, **Then** 该成员获得管理权限
5. **Given** 用户是普通成员, **When** 查看成员列表, **Then** 仅显示成员列表，无管理操作
6. **Given** 成员列表有 100+ 成员, **When** 查看, **Then** 支持分页或搜索

---

### User Story 6 - 群组讨论（帖子） (Priority: P1)

用户可以在群组内发表帖子，其他成员可以回复和点赞，形成讨论社区。

**Why this priority**: 讨论是群组的核心活动，用户需要发帖和互动。

**Independent Test**: 用户在群组内发布帖子"如何学习 Vue 3？"，验证帖子显示在群组讨论列表中。

**Acceptance Scenarios**:

1. **Given** 用户是群组成员, **When** 点击"发帖", **Then** 打开帖子编辑表单
2. **Given** 用户编辑帖子, **When** 输入标题和内容并发布, **Then** 帖子显示在群组讨论列表
3. **Given** 用户发布帖子, **When** 标题为空, **Then** 系统提示"标题不能为空"
4. **Given** 用户查看群组, **When** 有多个帖子, **Then** 按发布时间或热度排序显示
5. **Given** 用户点击帖子, **When** 打开详情页, **Then** 显示帖子内容和所有回复
6. **Given** 用户是帖子作者或管理员, **When** 点击"删除帖子", **Then** 帖子从列表中移除
7. **Given** 用户查看帖子, **When** 发表回复或点赞, **Then** 帖子互动数量增加

---

### User Story 7 - 群组隐私设置 (Priority: P1)

组长可以设置群组隐私级别（公开、需要审核、私密），控制谁可以加入和查看。

**Why this priority**: 隐私控制让群组有不同的开放程度，满足不同社区需求。

**Independent Test**: 组长将群组设置为"需要审核"，验证新用户申请加入时需要管理员审核。

**Acceptance Scenarios**:

1. **Given** 用户创建群组, **When** 选择隐私级别"公开", **Then** 所有人可以搜索、查看、加入群组
2. **Given** 用户创建群组, **When** 选择隐私级别"需要审核", **Then** 用户需要申请，管理员审核后加入
3. **Given** 用户创建群组, **When** 选择隐私级别"私密", **Then** 群组不在搜索结果中，仅邀请加入
4. **Given** 用户是组长, **When** 修改群组隐私级别, **Then** 新设置立即生效
5. **Given** 群组为"私密", **When** 非成员访问, **Then** 显示"该群组为私密群组"
6. **Given** 群组为"需要审核", **When** 用户申请加入, **Then** 管理员收到审核通知

---

### User Story 8 - 群组搜索 (Priority: P2)

用户可以搜索群组，按群组名称、简介、标签查找感兴趣的群组。

**Why this priority**: 搜索帮助用户发现感兴趣的群组，扩大群组影响力。

**Independent Test**: 用户在搜索框输入"前端"，验证返回所有名称或简介包含"前端"的群组。

**Acceptance Scenarios**:

1. **Given** 用户在群组页面, **When** 在搜索框输入关键词, **Then** 返回匹配的群组列表
2. **Given** 用户搜索群组, **When** 搜索结果有多页, **Then** 支持分页显示
3. **Given** 用户搜索群组, **When** 搜索结果包含私密群组, **Then** 私密群组不显示在搜索结果中
4. **Given** 用户查看搜索结果, **When** 点击群组, **Then** 跳转到群组详情页
5. **Given** 用户搜索无结果, **When** 没有匹配的群组, **Then** 显示"未找到相关群组"

---

### Edge Cases

- **群组名称重复**: 允许同名群组存在（使用 ID 区分）
- **组长转让**: 组长转让后原组长是否保留管理员身份
- **群组解散**: 解散群组后，群组内的帖子和评论是否保留（归档）
- **成员退出**: 成员退出后，其发表的帖子和评论是否保留
- **角色冲突**: 用户同时是组长和管理员（转让后的状态）
- **加入限制**: 群组是否支持最大成员数限制
- **邀请加入**: 私密群组是否支持成员邀请其他用户加入
- **群组标签**: 群组是否支持分类标签（如技术、娱乐、生活）

## Requirements *(mandatory)*

### Functional Requirements

#### 群组创建和管理
- **FR-001**: 用户 MUST 能够创建新群组并设置名称、简介、头像
- **FR-002**: 群组名称 MUST 限制在 50 字符以内
- **FR-003**: 群组简介 MUST 限制在 500 字符以内
- **FR-004**: 创建群组的用户 MUST 自动成为群组组长
- **FR-005**: 组长 MUST 能够编辑群组信息（名称、简介、头像）
- **FR-006**: 组长 MUST 能够解散群组
- **FR-007**: 解散群组 MUST 需要确认（防止误操作）
- **FR-008**: 解散群组 MUST 级联删除群组的所有内容（帖子、评论、成员关系）
- **FR-009**: 群组 MUST 记录创建时间和成员数量

#### 加入和退出群组
- **FR-010**: 用户 MUST 能够加入公开群组（无需审核）
- **FR-011**: 用户 MUST 能够申请加入需要审核的群组
- **FR-012**: 管理员 MUST 能够审核加入申请（批准或拒绝）
- **FR-013**: 用户加入群组后 MUST 成为普通成员
- **FR-014**: 用户 MUST 能够退出已加入的群组
- **FR-015**: 组长退出群组前 MUST 转让组长或解散群组
- **FR-016**: 用户退出群组 MUST 需要确认（防止误操作）
- **FR-017**: 私密群组 SHOULD 支持邀请加入（组长或管理员邀请）

#### 群组角色和权限
- **FR-018**: 群组 MUST 支持三种角色：组长（Owner）、管理员（Admin）、普通成员（Member）
- **FR-019**: 组长 MUST 拥有所有权限：编辑群组、设置管理员、移除成员、解散群组
- **FR-020**: 管理员 MUST 拥有管理权限：编辑群组信息、删除帖子、移除成员、审核加入申请
- **FR-021**: 普通成员 MUST 仅能发帖、评论、点赞
- **FR-022**: 组长 MUST 能够设置成员为管理员或移除管理员身份
- **FR-023**: 组长 MUST 能够转让组长身份给其他成员
- **FR-024**: 转让组长后原组长 SHOULD 变为普通成员或管理员（可配置）

#### 群组公告
- **FR-025**: 组长和管理员 MUST 能够发布群组公告
- **FR-026**: 公告 MUST 包含标题和内容
- **FR-027**: 公告 MUST 置顶显示在群组页面顶部
- **FR-028**: 组长和管理员 MUST 能够编辑或删除公告
- **FR-029**: 普通成员 MUST 不能发布或编辑公告
- **FR-030**: 公告 SHOULD 记录发布时间和发布人

#### 群组成员管理
- **FR-031**: 组长和管理员 MUST 能够查看成员列表
- **FR-032**: 成员列表 MUST 显示成员的角色（组长、管理员、成员）
- **FR-033**: 组长和管理员 MUST 能够移除成员
- **FR-034**: 移除成员 MUST 需要确认（防止误操作）
- **FR-035**: 被移除的成员 MUST 不能再访问群组内容
- **FR-036**: 成员列表 MUST 支持分页或搜索（成员数量较多时）

#### 群组讨论（帖子）
- **FR-037**: 群组成员 MUST 能够在群组内发表帖子
- **FR-038**: 帖子 MUST 包含标题和内容
- **FR-039**: 帖子标题 MUST 限制在 200 字符以内
- **FR-040**: 帖子内容 MUST 限制在 10000 字符以内
- **FR-041**: 帖子 MUST 支持评论和点赞（复用评论系统）
- **FR-042**: 帖子列表 MUST 按发布时间或热度排序
- **FR-043**: 帖子作者或管理员 MUST 能够删除帖子
- **FR-044**: 删除帖子 MUST 级联删除帖子的所有评论
- **FR-045**: 帖子 MUST 记录发布时间、作者、浏览次数、回复数、点赞数

#### 群组隐私设置
- **FR-046**: 群组 MUST 支持三种隐私级别：公开（Public）、需要审核（NeedApproval）、私密（Private）
- **FR-047**: 公开群组 MUST 允许所有人搜索、查看、加入
- **FR-048**: 需要审核群组 MUST 允许所有人搜索、查看，但需要申请加入
- **FR-049**: 私密群组 MUST 不在搜索结果中显示，仅邀请加入
- **FR-050**: 组长 MUST 能够修改群组隐私级别

#### 群组搜索
- **FR-051**: 用户 MUST 能够搜索群组（按名称或简介）
- **FR-052**: 搜索 MUST 支持模糊匹配（LIKE 查询）
- **FR-053**: 搜索结果 MUST 不包含私密群组
- **FR-054**: 搜索结果 MUST 支持分页，每页显示 20 个群组
- **FR-055**: 搜索结果 SHOULD 高亮显示匹配的关键词

### Key Entities

#### Group (群组实体)
- **Id** (long, 主键): 群组 ID
- **Name** (string, 50字符): 群组名称
- **Description** (string, 500字符): 群组简介
- **Avatar** (string, 500字符): 群组头像 URL
- **OwnerId** (long, 外键): 群组组长用户 ID
- **Privacy** (enum): 隐私级别（Public=0, NeedApproval=1, Private=2）
- **CreateTime** (DateTime): 创建时间
- **MemberCount** (int): 成员数量（冗余字段）
- **索引**: (Name) 用于搜索
- **索引**: (CreateTime) 用于排序

#### GroupUser (群组成员实体)
- **Id** (long, 主键): 记录 ID
- **GroupId** (long, 外键): 群组 ID
- **UserId** (long, 外键): 用户 ID
- **Role** (enum): 角色（Owner=0, Admin=1, Member=2）
- **JoinTime** (DateTime): 加入时间
- **唯一索引**: (GroupId, UserId) 防止重复加入
- **索引**: (UserId, JoinTime) 用于查询用户的群组

#### GroupPost (群组帖子实体)
- **Id** (long, 主键): 帖子 ID
- **GroupId** (long, 外键): 所属群组 ID
- **UserId** (long, 外键): 发帖用户 ID
- **Title** (string, 200字符): 帖子标题
- **Content** (text): 帖子内容
- **CreateTime** (DateTime): 发布时间
- **ViewCount** (int): 浏览次数
- **ReplyCount** (int): 回复数量（冗余字段）
- **LikeCount** (int): 点赞数量（冗余字段）
- **索引**: (GroupId, CreateTime) 用于帖子列表查询
- **索引**: (GroupId, LikeCount) 用于热门排序

#### GroupAnnouncement (群组公告实体)
- **Id** (long, 主键): 公告 ID
- **GroupId** (long, 外键): 所属群组 ID
- **UserId** (long, 外键): 发布人用户 ID
- **Title** (string, 200字符): 公告标题
- **Content** (text): 公告内容
- **CreateTime** (DateTime): 发布时间
- **索引**: (GroupId, CreateTime) 用于公告查询

#### GroupJoinRequest (加入申请实体)
- **Id** (long, 主键): 申请 ID
- **GroupId** (long, 外键): 申请的群组 ID
- **UserId** (long, 外键): 申请人用户 ID
- **Message** (string, 500字符, 可选): 申请留言
- **Status** (enum): 申请状态（Pending=0, Approved=1, Rejected=2）
- **CreateTime** (DateTime): 申请时间
- **HandleTime** (DateTime, 可选): 处理时间
- **HandlerId** (long, 可选): 处理管理员 ID
- **索引**: (GroupId, Status) 用于待审核列表

## Success Criteria *(mandatory)*

### Measurable Outcomes

- **SC-001**: 群组创建操作在 1 秒内完成
- **SC-002**: 群组列表在 500 毫秒内加载完成（100 个群组）
- **SC-003**: 群组搜索在 1 秒内返回结果（1000 个群组）
- **SC-004**: 加入群组操作在 500 毫秒内完成
- **SC-005**: 成员列表在 1 秒内加载完成（500 名成员）
- **SC-006**: 帖子列表在 1 秒内加载完成（100 个帖子）
- **SC-007**: 用户平均加入 5 个以上群组
- **SC-008**: 群组日均活跃帖子数 > 10 个（活跃群组）
- **SC-009**: 群组成员留存率 > 70%（30 天内）
- **SC-010**: 群组搜索使用率 > 30%（用户通过搜索发现群组）

## Assumptions *(optional)*

### Technical Assumptions
- 群组数据存储在数据库中
- 群组搜索使用数据库全文索引或 Elasticsearch
- 群组成员数量使用冗余字段（实时更新或定时同步）
- 群组帖子复用评论系统
- 群组公告使用单独表存储

### Business Assumptions
- 用户平均加入 5 个群组
- 大部分群组是公开或需要审核（占比 80%）
- 群组平均有 50 名成员
- 群组每天新增 10 个帖子（活跃群组）
- 群组组长积极管理群组

### User Experience Assumptions
- 用户期望快速加入群组（无繁琐流程）
- 用户希望群组有明确的主题和规则
- 用户希望群组讨论有序（管理员维护）
- 用户希望发现感兴趣的群组（搜索和推荐）

## Dependencies *(optional)*

### Internal Dependencies
- **用户认证与授权系统 (#001)**: 提供用户身份验证
- **用户资料系统 (#002)**: 提供用户头像和用户名
- **活动动态系统 (#005)**: 生成"加入群组"、"发帖"动态事件
- **评论系统 (#008)**: 提供帖子评论功能
- 通知系统（未来）: 集成加入申请、公告通知

### External Dependencies
- **数据库全文搜索**: PostgreSQL FTS 或 Elasticsearch
- **文件上传服务**: 支持群组头像上传

## Out of Scope *(optional)*

以下功能**不在**本次规格范围内：

- 群组活动功能（线上/线下活动） - 属于扩展功能
- 群组文件共享 - 属于文件管理功能
- 群组投票功能 - 属于互动增强功能
- 群组徽章或等级系统 - 属于激励系统
- 群组推荐算法 - 属于算法优化
- 群组分类目录 - 属于内容组织功能
- 群组数据统计（活跃度、成长趋势） - 属于数据分析
- 群组联盟或子群组 - 属于高级功能

## Notes *(optional)*

### Security Considerations
- 群组隐私过滤必须在数据库查询层实现
- 群组角色权限必须严格验证
- 群组成员移除需要确认（防止误操作）
- 群组解散需要二次确认（防止恶意操作）

### Performance Considerations
- 群组列表查询使用索引（Name, CreateTime）
- 成员列表查询使用索引（GroupId, UserId）
- 帖子列表查询使用索引（GroupId, CreateTime）
- 成员数量使用冗余字段（异步更新）
- 群组搜索使用全文索引

### Scalability Considerations
- 群组表按时间或 ID 分表
- 热门群组的帖子可以单独缓存
- 成员列表使用分页减少查询压力
- 群组搜索使用 Elasticsearch（高并发场景）

### User Experience Considerations
- 群组加入操作即时反馈
- 群组搜索结果高亮关键词
- 群组成员列表支持搜索和筛选
- 群组公告置顶显示（醒目）
- 群组帖子支持排序（最新、热门）

### Open Questions for Future Iterations
- 是否需要支持群组活动功能？
- 是否需要支持群组文件共享？
- 是否需要群组推荐算法？
- 是否需要群组分类目录？
- 是否需要群组投票功能？
- 群组是否支持最大成员数限制？
