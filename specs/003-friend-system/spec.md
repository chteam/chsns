# Feature Specification: 好友系统

**Feature Branch**: `003-friend-system`  
**Created**: 2025-11-13  
**Status**: Draft  
**Input**: 好友系统：添加好友、接受拒绝好友请求、删除好友、好友分组、好友搜索、好友列表展示、双向好友确认机制

## User Scenarios & Testing *(mandatory)*

### User Story 1 - 添加好友 (Priority: P1)

用户可以通过搜索或浏览找到其他用户，并发送好友请求。对方需要确认后才能成为好友。

**Why this priority**: 好友关系是社交网络的核心，没有好友就无法进行社交互动。双向确认保证用户自主控制社交圈。

**Independent Test**: 用户 A 搜索并向用户 B 发送好友请求，用户 B 在通知中看到请求并确认，验证双方成为好友。

**Acceptance Scenarios**:

1. **Given** 用户 A 搜索用户名, **When** 找到用户 B 并点击"加为好友", **Then** 系统发送好友请求并显示"等待确认"
2. **Given** 用户 B 收到好友请求, **When** 点击"接受", **Then** 系统建立双向好友关系
3. **Given** 用户 B 收到好友请求, **When** 点击"拒绝", **Then** 系统删除请求记录
4. **Given** 用户 A 已向用户 B 发送请求, **When** 再次访问 B 的资料页, **Then** 显示"等待确认"而非"加为好友"按钮
5. **Given** 用户 A 和 B 已是好友, **When** A 访问 B 的资料页, **Then** 显示"已是好友"状态

---

### User Story 2 - 查看好友列表 (Priority: P1)

用户可以查看自己的好友列表，显示好友头像、用户名、在线状态。支持搜索和筛选好友。

**Why this priority**: 好友列表是用户管理社交关系的入口，必须方便访问和查找好友。

**Independent Test**: 访问好友列表页面，验证显示所有已确认的好友，并支持按用户名搜索。

**Acceptance Scenarios**:

1. **Given** 用户访问好友列表, **When** 页面加载, **Then** 显示所有好友（头像、用户名、在线状态）
2. **Given** 用户有 100+ 好友, **When** 好友列表加载, **Then** 使用分页每页显示 20 个好友
3. **Given** 用户在好友列表搜索框输入关键词, **When** 输入"张三", **Then** 实时过滤显示匹配的好友
4. **Given** 用户查看好友列表, **When** 好友在线, **Then** 显示绿色在线图标
5. **Given** 用户点击好友头像, **When** 跳转到好友资料页, **Then** 显示完整资料

---

### User Story 3 - 删除好友 (Priority: P1)

用户可以删除已添加的好友，解除好友关系。删除操作需要确认，防止误操作。

**Why this priority**: 用户需要自主管理社交关系，删除不再联系的好友或清理社交圈。

**Independent Test**: 在好友列表中删除某个好友，验证好友关系解除且双方好友列表都不再显示对方。

**Acceptance Scenarios**:

1. **Given** 用户在好友列表, **When** 点击"删除好友"按钮, **Then** 系统弹出确认对话框
2. **Given** 用户确认删除, **When** 点击"确定", **Then** 系统删除好友关系并刷新列表
3. **Given** 用户 A 删除好友 B, **When** 删除成功, **Then** A 的好友列表不再显示 B
4. **Given** 用户 A 删除好友 B, **When** B 访问自己的好友列表, **Then** B 的列表也不再显示 A
5. **Given** 用户删除好友后, **When** 访问对方资料页, **Then** 重新显示"加为好友"按钮

---

### User Story 4 - 好友分组 (Priority: P2)

用户可以创建好友分组（如"同事"、"家人"、"同学"），并将好友分配到不同分组。支持一个好友属于多个分组。

**Why this priority**: 好友分组帮助用户组织社交关系，方便管理和定向分享内容。

**Independent Test**: 创建分组"同事"，将好友 A 和 B 添加到该分组，验证分组列表显示正确。

**Acceptance Scenarios**:

1. **Given** 用户在好友管理页面, **When** 点击"创建分组", **Then** 输入分组名称并保存
2. **Given** 用户选择好友, **When** 点击"添加到分组", **Then** 选择分组并成功添加
3. **Given** 用户查看分组, **When** 点击分组名称, **Then** 显示该分组的所有好友
4. **Given** 用户删除分组, **When** 确认删除, **Then** 系统删除分组但不删除好友关系
5. **Given** 好友属于多个分组, **When** 查看好友详情, **Then** 显示该好友所属的所有分组

---

### User Story 5 - 好友请求管理 (Priority: P2)

用户可以查看收到的好友请求列表，批量接受或拒绝请求。已发送的请求可以撤回。

**Why this priority**: 集中管理好友请求提高效率，避免遗漏或误操作。

**Independent Test**: 收到多个好友请求，批量接受部分请求并拒绝其他，验证请求状态正确更新。

**Acceptance Scenarios**:

1. **Given** 用户收到多个好友请求, **When** 访问请求列表, **Then** 显示所有待处理请求
2. **Given** 用户选择多个请求, **When** 点击"批量接受", **Then** 系统建立所有选中的好友关系
3. **Given** 用户已发送请求, **When** 在"已发送"列表中点击"撤回", **Then** 系统删除请求记录
4. **Given** 用户忽略请求, **When** 超过 30 天未处理, **Then** 系统自动删除过期请求
5. **Given** 用户拒绝请求, **When** 对方再次发送请求, **Then** 系统允许重新发送（无限制）

---

### User Story 6 - 共同好友显示 (Priority: P3)

用户查看他人资料时，系统显示共同好友数量和列表，增强信任感。

**Why this priority**: 共同好友帮助用户判断社交距离，促进陌生人之间的连接。

**Independent Test**: 用户 A 和 C 都是用户 B 的好友，A 查看 C 的资料时显示"1 个共同好友"。

**Acceptance Scenarios**:

1. **Given** 用户 A 查看用户 C 的资料, **When** A 和 C 有共同好友, **Then** 显示共同好友数量
2. **Given** 用户点击共同好友数量, **When** 打开列表, **Then** 显示所有共同好友的头像和用户名
3. **Given** 用户 A 和 C 无共同好友, **When** 查看资料, **Then** 不显示共同好友信息
4. **Given** 用户查看共同好友列表, **When** 点击某个好友, **Then** 跳转到该好友的资料页

---

### Edge Cases

- **双向请求**: A 向 B 发送请求，B 同时向 A 发送请求，系统应自动合并为好友关系
- **重复请求**: A 向 B 重复发送多次请求，系统应忽略重复请求
- **并发确认**: 多个用户同时接受好友请求，系统应保证好友关系唯一性
- **好友上限**: 用户好友数达到上限（如 5000），无法再添加新好友
- **已删除用户**: 好友账户被删除或禁用，好友列表应隐藏或标记该用户
- **分组循环**: 用户尝试将好友从 A 组移到 B 组再移回 A 组，系统应正确处理
- **匿名浏览**: 用户设置匿名浏览后，是否应在好友列表显示在线状态

## Requirements *(mandatory)*

### Functional Requirements

#### 好友关系管理
- **FR-001**: 系统 MUST 支持双向好友确认机制，单方发起不建立好友关系
- **FR-002**: 用户 MUST 能够搜索其他用户（按用户名或ID）并发送好友请求
- **FR-003**: 好友请求 MUST 包含以下状态：待确认（IsTrue=false）、已确认（IsTrue=true）
- **FR-004**: 用户 MUST 能够接受或拒绝好友请求
- **FR-005**: 接受请求后系统 MUST 创建双向好友记录（FromId/ToId 互换的两条记录）
- **FR-006**: 用户 MUST 能够删除好友，删除操作 MUST 同时删除双向记录
- **FR-007**: 用户 MUST 能够查看自己的好友列表（仅显示 IsTrue=true 的记录）
- **FR-008**: 用户 MUST 能够查看待处理的好友请求列表
- **FR-009**: 用户 MUST 能够撤回自己发送的好友请求

#### 好友列表与展示
- **FR-010**: 好友列表 MUST 显示好友头像、用户名、在线状态
- **FR-011**: 好友列表 MUST 支持分页，默认每页 20 个好友
- **FR-012**: 好友列表 MUST 支持实时搜索（按用户名过滤）
- **FR-013**: 系统 MUST 显示用户的好友总数
- **FR-014**: 用户资料页 MUST 显示该用户的公开好友列表（受隐私设置限制）
- **FR-015**: 好友列表 MUST 支持按在线状态、最近联系排序

#### 好友分组
- **FR-016**: 用户 MUST 能够创建自定义好友分组
- **FR-017**: 分组名称 MUST 限制在 20 字符以内
- **FR-018**: 用户 MUST 能够将好友添加到一个或多个分组
- **FR-019**: 用户 MUST 能够删除分组，删除分组 MUST 不删除好友关系
- **FR-020**: 系统 MUST 支持查看特定分组的好友列表
- **FR-021**: 分组数量 MUST 限制在 50 个以内

#### 好友请求管理
- **FR-022**: 用户 MUST 能够查看收到的好友请求列表
- **FR-023**: 用户 MUST 能够查看已发送的好友请求列表
- **FR-024**: 用户 MUST 能够批量接受或拒绝好友请求
- **FR-025**: 好友请求 MUST 在 30 天后自动过期并删除
- **FR-026**: 拒绝请求后对方 MUST 可以重新发送请求（无次数限制）
- **FR-027**: 系统 MUST 在收到好友请求时通知用户

#### 共同好友
- **FR-028**: 用户查看他人资料时 MUST 显示共同好友数量
- **FR-029**: 用户 MUST 能够查看共同好友列表
- **FR-030**: 共同好友计算 MUST 仅包含双向确认的好友关系
- **FR-031**: 共同好友列表 MUST 受隐私设置限制（如果对方隐藏好友列表则不显示）

#### 隐私与安全
- **FR-032**: 用户 MUST 能够设置好友列表的可见性（公开/仅好友/仅自己）
- **FR-033**: 用户 MUST 能够屏蔽特定用户，屏蔽后双方无法发送好友请求
- **FR-034**: 好友上限 MUST 设置为 5000 人（可配置）
- **FR-035**: 系统 MUST 记录好友关系变更日志（添加、删除时间）

### Key Entities

#### Friend (好友关系)
- **Id** (long, 主键): 关系 ID
- **FromId** (long, 外键): 发起方用户 ID
- **ToId** (long, 外键): 接收方用户 ID
- **IsTrue** (bool): 是否已确认（true=好友, false=待确认）
- **IsCommon** (bool): 是否为共同好友（冗余字段，优化查询）
- **FriendType** (int, 可选): 好友类型（0=普通, 1=亲密, 2=特别关注）
- **FriendSummary** (int, 可选): 好友备注或分组 ID
- **CreatedAt** (DateTime): 关系创建时间
- **ConfirmedAt** (DateTime, 可选): 确认时间
- **唯一约束**: (FromId, ToId) 防止重复关系

#### FriendGroup (好友分组)
- **Id** (long, 主键): 分组 ID
- **UserId** (long, 外键): 用户 ID
- **Name** (string, 20字符): 分组名称
- **Order** (int): 显示顺序
- **CreatedAt** (DateTime): 创建时间

#### FriendGroupMember (分组成员)
- **Id** (long, 主键): 成员记录 ID
- **GroupId** (long, 外键): 分组 ID
- **FriendId** (long, 外键): 好友用户 ID
- **UserId** (long, 外键): 分组所有者 ID
- **CreatedAt** (DateTime): 添加时间
- **唯一约束**: (GroupId, FriendId) 防止重复添加

## Success Criteria *(mandatory)*

### Measurable Outcomes

- **SC-001**: 用户可以在 30 秒内完成添加好友流程（搜索、发送请求）
- **SC-002**: 好友列表在 1 秒内加载完成（100 个好友）
- **SC-003**: 好友搜索在 300 毫秒内返回结果
- **SC-004**: 系统支持 10,000 个并发好友请求操作不出现错误
- **SC-005**: 共同好友计算在 500 毫秒内完成（1000 个好友）
- **SC-006**: 好友请求通知在 5 秒内送达
- **SC-007**: 用户添加好友后，社交互动频率提升 60%
- **SC-008**: 好友分组功能使用率达到 40% 以上
- **SC-009**: 好友关系数据一致性 100%（无孤立记录）
- **SC-010**: 批量操作（批量接受请求）在 3 秒内完成（10 个请求）

## Assumptions *(optional)*

### Technical Assumptions
- 好友关系使用数据库唯一约束保证数据一致性
- 在线状态通过缓存服务（Redis）实时更新
- 共同好友查询使用数据库 JOIN 或应用层计算

### Business Assumptions
- 用户平均好友数为 50-200 人
- 好友请求接受率约 70%
- 用户不会频繁删除好友（每月 < 5 次）

### User Experience Assumptions
- 用户期望好友列表实时更新
- 用户希望看到好友的在线状态
- 用户需要搜索和分组来管理大量好友

## Dependencies *(optional)*

### Internal Dependencies
- **用户认证与授权系统 (#001)**: 提供用户身份验证
- **用户资料系统 (#002)**: 提供用户头像、用户名等基本信息
- 通知系统（未来）: 发送好友请求通知

### External Dependencies
- **数据库**: 支持事务和唯一约束
- **缓存服务**: Redis 用于在线状态

## Out of Scope *(optional)*

以下功能**不在**本次规格范围内：

- 好友推荐算法 - 属于推荐系统
- 好友动态时间线 - 属于动态流系统
- 好友黑名单 - 属于隐私增强功能
- 好友亲密度计算 - 属于数据分析功能
- 好友标签（非分组） - 属于扩展功能

## Notes *(optional)*

### Performance Considerations
- 好友列表查询使用数据库索引（FromId, IsTrue）
- 共同好友查询可以异步计算并缓存
- 在线状态使用 Redis 缓存，TTL 5 分钟

### Scalability Considerations
- 好友关系表可以按用户 ID 哈希分表
- 好友请求可以使用消息队列异步处理
