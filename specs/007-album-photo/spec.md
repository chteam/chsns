# Feature Specification: 相册照片系统

**Feature Branch**: `007-album-photo`  
**Created**: 2025-11-14  
**Status**: Draft  
**Input**: 相册照片系统：创建相册、上传照片、照片描述标签、相册封面、照片浏览轮播、照片评论点赞、相册隐私设置、照片批量操作

## User Scenarios & Testing *(mandatory)*

### User Story 1 - 创建和管理相册 (Priority: P1)

用户可以创建相册，设置相册名称、描述和封面，组织和管理自己的照片。

**Why this priority**: 相册是照片管理的基础容器，用户需要将照片分组整理，方便查看和分享。

**Independent Test**: 用户点击"创建相册"按钮，输入相册名称"旅行 2025"，保存后在个人主页看到该相册。

**Acceptance Scenarios**:

1. **Given** 用户在个人主页, **When** 点击"创建相册", **Then** 打开相册创建表单
2. **Given** 用户填写相册名称和描述, **When** 点击"保存", **Then** 相册创建成功并显示在相册列表
3. **Given** 用户创建相册, **When** 相册名称为空, **Then** 系统提示"相册名称不能为空"
4. **Given** 用户创建相册, **When** 相册名称超过 100 字符, **Then** 系统提示"相册名称过长"
5. **Given** 用户查看相册列表, **When** 有多个相册, **Then** 按创建时间倒序显示（最新的在最前）
6. **Given** 用户编辑相册, **When** 修改相册名称或描述, **Then** 更新保存成功
7. **Given** 用户删除相册, **When** 相册内有照片, **Then** 系统提示"相册内有 N 张照片，确认删除？"
8. **Given** 用户删除相册, **When** 确认删除, **Then** 相册及所有照片从列表中移除

---

### User Story 2 - 上传和管理照片 (Priority: P1)

用户可以上传照片到指定相册，支持单张或批量上传。照片上传后自动生成缩略图。

**Why this priority**: 照片上传是相册系统的核心功能，用户需要快速便捷地添加照片。

**Independent Test**: 用户在相册详情页点击"上传照片"，选择 5 张图片，验证上传成功并显示在相册中。

**Acceptance Scenarios**:

1. **Given** 用户在相册详情页, **When** 点击"上传照片", **Then** 打开文件选择对话框
2. **Given** 用户选择照片文件, **When** 点击"打开", **Then** 照片开始上传并显示进度条
3. **Given** 用户上传照片, **When** 上传完成, **Then** 照片显示在相册中并生成缩略图
4. **Given** 用户批量上传照片, **When** 选择多个文件, **Then** 系统并发上传所有照片
5. **Given** 用户上传照片, **When** 文件类型不是图片（如 .txt）, **Then** 系统提示"仅支持图片格式"
6. **Given** 用户上传照片, **When** 单张照片超过 10MB, **Then** 系统提示"照片文件过大"
7. **Given** 用户上传照片, **When** 一次上传超过 50 张, **Then** 系统提示"最多一次上传 50 张照片"
8. **Given** 用户上传照片后, **When** 系统生成缩略图, **Then** 缩略图尺寸为 200x200（等比缩放）

---

### User Story 3 - 照片描述和标签 (Priority: P2)

用户可以为照片添加描述和标签，方便查找和分类。标签支持全站共享。

**Why this priority**: 描述和标签帮助用户组织照片，提升检索效率。

**Independent Test**: 用户点击照片编辑按钮，添加描述"巴黎铁塔"和标签"旅行, 法国"，保存后验证显示正确。

**Acceptance Scenarios**:

1. **Given** 用户查看照片详情, **When** 点击"编辑"按钮, **Then** 打开照片编辑表单
2. **Given** 用户编辑照片, **When** 输入描述文字, **Then** 描述保存并显示在照片下方
3. **Given** 用户编辑照片, **When** 添加标签, **Then** 标签关联到照片
4. **Given** 用户添加标签, **When** 标签已存在, **Then** 系统自动补全建议
5. **Given** 用户点击照片标签, **When** 跳转到标签页面, **Then** 显示全站所有包含该标签的照片
6. **Given** 用户编辑照片描述, **When** 描述超过 500 字符, **Then** 系统提示"描述过长"

---

### User Story 4 - 设置相册封面 (Priority: P2)

用户可以为相册设置封面照片，封面显示在相册列表中作为相册的代表图片。

**Why this priority**: 封面照片让相册列表更直观，提升视觉吸引力。

**Independent Test**: 用户在相册中选择一张照片，点击"设为封面"，验证相册列表中显示该照片作为封面。

**Acceptance Scenarios**:

1. **Given** 用户查看相册中的照片, **When** 点击"设为封面", **Then** 该照片成为相册封面
2. **Given** 用户设置封面, **When** 相册列表刷新, **Then** 相册显示新封面图片
3. **Given** 相册没有设置封面, **When** 相册有照片, **Then** 系统自动使用第一张照片作为封面
4. **Given** 相册没有照片, **When** 相册列表显示, **Then** 显示默认占位图片

---

### User Story 5 - 照片浏览和轮播 (Priority: P1)

用户可以点击照片查看大图，支持轮播模式（上一张/下一张），提供沉浸式浏览体验。

**Why this priority**: 照片浏览是核心用户体验，用户需要方便地查看和欣赏照片。

**Independent Test**: 用户点击相册中的照片，打开大图查看器，点击"下一张"按钮验证可以浏览所有照片。

**Acceptance Scenarios**:

1. **Given** 用户在相册中, **When** 点击照片缩略图, **Then** 打开大图查看器（Lightbox）
2. **Given** 用户查看大图, **When** 点击"下一张"按钮或按键盘右箭头, **Then** 切换到下一张照片
3. **Given** 用户查看大图, **When** 点击"上一张"按钮或按键盘左箭头, **Then** 切换到上一张照片
4. **Given** 用户查看大图, **When** 按 Esc 键或点击关闭按钮, **Then** 关闭大图查看器
5. **Given** 用户查看大图, **When** 照片加载中, **Then** 显示加载动画（spinner）
6. **Given** 用户查看大图, **When** 滑动手势（移动端）, **Then** 支持左右滑动切换照片

---

### User Story 6 - 照片评论和点赞 (Priority: P2)

用户可以对照片点赞和评论，与照片作者或其他访客互动。

**Why this priority**: 评论和点赞是社交互动的基础，增强用户参与感。

**Independent Test**: 用户在照片详情页点击"点赞"按钮，验证点赞数量增加，发表评论后验证显示在照片下方。

**Acceptance Scenarios**:

1. **Given** 用户查看照片, **When** 点击"点赞"按钮, **Then** 点赞数量 +1 且按钮变为"已点赞"状态
2. **Given** 用户已点赞, **When** 再次点击"取消点赞", **Then** 点赞数量 -1 且按钮恢复为"点赞"
3. **Given** 用户查看照片, **When** 在评论框输入内容并发表, **Then** 评论显示在照片下方
4. **Given** 用户发表评论, **When** 评论内容超过 500 字符, **Then** 系统提示"评论过长"
5. **Given** 用户删除自己的评论, **When** 确认删除, **Then** 评论从列表中移除
6. **Given** 照片作者查看照片, **When** 有新的点赞或评论, **Then** 收到通知（可选）

---

### User Story 7 - 相册隐私设置 (Priority: P1)

用户可以为相册设置隐私级别（公开、仅好友、仅自己、密码保护），控制谁可以查看。

**Why this priority**: 隐私控制是用户对内容管理的核心需求，不同相册有不同的分享需求。

**Independent Test**: 用户创建相册并设置"仅好友可见"，验证非好友无法访问该相册。

**Acceptance Scenarios**:

1. **Given** 用户创建相册, **When** 选择隐私级别"公开", **Then** 所有人可以访问（包括游客）
2. **Given** 用户创建相册, **When** 选择隐私级别"仅好友", **Then** 仅好友可以访问
3. **Given** 用户创建相册, **When** 选择隐私级别"仅自己", **Then** 仅作者本人可以访问
4. **Given** 用户创建相册, **When** 选择隐私级别"密码保护", **Then** 访问者需要输入密码
5. **Given** 非好友访问"仅好友"相册, **When** 尝试打开相册链接, **Then** 显示"无权限访问"
6. **Given** 用户修改相册隐私, **When** 从"公开"改为"仅好友", **Then** 非好友立即无法访问

---

### User Story 8 - 照片批量操作 (Priority: P2)

用户可以批量选择照片，执行移动、删除、下载等操作，提升管理效率。

**Why this priority**: 批量操作减少重复劳动，提升用户体验，特别是管理大量照片时。

**Independent Test**: 用户在相册中勾选 10 张照片，点击"批量删除"，验证所有选中照片被删除。

**Acceptance Scenarios**:

1. **Given** 用户在相册中, **When** 勾选多张照片, **Then** 底部显示批量操作工具栏
2. **Given** 用户选择照片, **When** 点击"批量删除", **Then** 系统提示"确认删除 N 张照片？"
3. **Given** 用户确认批量删除, **When** 操作完成, **Then** 所有选中照片从相册中移除
4. **Given** 用户选择照片, **When** 点击"移动到其他相册", **Then** 打开相册选择器并移动照片
5. **Given** 用户选择照片, **When** 点击"批量下载", **Then** 系统打包下载所有选中照片（ZIP）
6. **Given** 用户选择照片, **When** 点击"取消选择", **Then** 清除所有勾选状态

---

### Edge Cases

- **相册名称重复**: 用户创建多个同名相册，系统应允许（使用 ID 区分）
- **照片上传失败**: 网络中断导致上传失败，系统应支持重新上传
- **大图加载失败**: 照片文件损坏或丢失，显示"图片加载失败"占位图
- **照片格式**: 用户上传非标准格式图片（如 HEIC），系统应转换或拒绝
- **照片元数据**: 照片包含 EXIF 信息（拍摄时间、地点），系统是否提取和显示
- **相册删除**: 用户删除相册后，照片文件是否物理删除（存储清理）
- **标签冲突**: 系统存在重复标签（如"travel"和"Travel"），应支持合并
- **并发上传**: 用户在两个设备同时上传照片到同一相册，应正确处理

## Requirements *(mandatory)*

### Functional Requirements

#### 相册创建和管理
- **FR-001**: 用户 MUST 能够创建新相册并设置名称和描述
- **FR-002**: 相册名称 MUST 限制在 100 字符以内
- **FR-003**: 相册描述 MUST 限制在 500 字符以内
- **FR-004**: 用户 MUST 能够编辑相册名称和描述
- **FR-005**: 用户 MUST 能够删除自己的相册
- **FR-006**: 删除相册时 MUST 同时删除相册中的所有照片（级联删除）
- **FR-007**: 用户 MUST 能够为相册设置隐私级别（公开、仅好友、仅自己、密码保护）
- **FR-008**: 用户 MUST 能够为相册设置封面照片
- **FR-009**: 相册 MUST 记录创建时间和更新时间
- **FR-010**: 相册列表 MUST 显示相册名称、封面、照片数量、创建时间

#### 照片上传和存储
- **FR-011**: 用户 MUST 能够上传照片到指定相册
- **FR-012**: 系统 MUST 支持单张或批量上传照片（最多 50 张一次）
- **FR-013**: 照片文件 MUST 限制格式为 JPG, PNG, GIF, WEBP
- **FR-014**: 单张照片文件 MUST 限制大小在 10MB 以内
- **FR-015**: 系统 MUST 在照片上传后自动生成缩略图（200x200 像素）
- **FR-016**: 系统 SHOULD 生成多种尺寸的缩略图（小、中、大）
- **FR-017**: 照片 MUST 记录原始文件名、文件大小、宽度、高度
- **FR-018**: 照片 MUST 记录上传时间和排序顺序
- **FR-019**: 系统 SHOULD 提取照片 EXIF 信息（拍摄时间、设备、地理位置）

#### 照片描述和标签
- **FR-020**: 用户 MUST 能够为照片添加描述文字
- **FR-021**: 照片描述 MUST 限制在 500 字符以内
- **FR-022**: 用户 MUST 能够为照片添加标签（多选，最多 10 个）
- **FR-023**: 标签 MUST 全站共享（所有用户的照片共用标签库）
- **FR-024**: 标签输入 SHOULD 支持自动补全建议
- **FR-025**: 点击标签 MUST 显示全站所有包含该标签的照片（隐私过滤）

#### 照片浏览
- **FR-026**: 用户 MUST 能够查看相册中的所有照片（网格布局）
- **FR-027**: 点击照片 MUST 打开大图查看器（Lightbox）
- **FR-028**: 大图查看器 MUST 支持上一张/下一张切换
- **FR-029**: 大图查看器 MUST 支持键盘快捷键（左右箭头、Esc）
- **FR-030**: 大图查看器 SHOULD 支持触摸手势（移动端左右滑动）
- **FR-031**: 照片大图 MUST 显示照片描述、标签、点赞数、评论数
- **FR-032**: 照片浏览 MUST 支持分页或无限滚动

#### 照片评论和点赞
- **FR-033**: 用户 MUST 能够对照片点赞
- **FR-034**: 用户 MUST 能够取消点赞
- **FR-035**: 系统 MUST 实时更新点赞数量
- **FR-036**: 用户 MUST 能够查看点赞用户列表
- **FR-037**: 用户 MUST 能够对照片发表评论
- **FR-038**: 评论 MUST 限制在 500 字符以内
- **FR-039**: 评论 MUST 支持嵌套回复（@用户名）
- **FR-040**: 用户 MUST 能够删除自己的评论
- **FR-041**: 照片作者 MUST 能够删除自己照片下的任何评论
- **FR-042**: 评论列表 MUST 按时间正序排列

#### 相册隐私
- **FR-043**: 相册隐私 MUST 支持四种级别：公开（Public）、仅好友（FriendsOnly）、仅自己（Private）、密码保护（Password）
- **FR-044**: 公开相册 MUST 允许所有人访问（包括游客）
- **FR-045**: 仅好友相册 MUST 仅允许好友访问
- **FR-046**: 仅自己相册 MUST 仅允许作者本人访问
- **FR-047**: 密码保护相册 MUST 要求访问者输入正确密码
- **FR-048**: 非授权用户访问受限相册时 MUST 显示"无权限访问"
- **FR-049**: 用户 MUST 能够修改相册的隐私级别

#### 照片批量操作
- **FR-050**: 用户 MUST 能够批量选择照片
- **FR-051**: 用户 MUST 能够批量删除选中的照片
- **FR-052**: 用户 MUST 能够批量移动照片到其他相册
- **FR-053**: 用户 SHOULD 能够批量下载照片（ZIP 打包）
- **FR-054**: 批量操作 MUST 显示进度条（操作耗时超过 2 秒时）

#### 照片管理
- **FR-055**: 用户 MUST 能够删除单张照片
- **FR-056**: 用户 MUST 能够调整照片在相册中的排序
- **FR-057**: 照片 MUST 记录浏览次数
- **FR-058**: 相册 MUST 记录照片总数（冗余字段，性能优化）

### Key Entities

#### Album (相册实体)
- **Id** (long, 主键): 相册 ID
- **UserId** (long, 外键): 相册所有者用户 ID
- **Name** (string, 100字符): 相册名称
- **Description** (string, 500字符): 相册描述
- **CoverPhotoId** (long, 外键, 可选): 封面照片 ID
- **Privacy** (enum): 隐私级别（Public=0, FriendsOnly=1, Private=2, Password=3）
- **Password** (string, 可选): 密码保护的密码（加密存储）
- **CreateTime** (DateTime): 创建时间
- **UpdateTime** (DateTime): 最后更新时间
- **PhotoCount** (int): 照片数量（冗余字段）
- **索引**: (UserId, CreateTime) 用于相册列表查询

#### Photo (照片实体)
- **Id** (long, 主键): 照片 ID
- **AlbumId** (long, 外键): 所属相册 ID
- **UserId** (long, 外键): 上传者用户 ID
- **FileName** (string, 255字符): 原始文件名
- **FilePath** (string, 500字符): 文件存储路径
- **ThumbnailPath** (string, 500字符): 缩略图路径
- **Description** (string, 500字符): 照片描述
- **FileSize** (long): 文件大小（字节）
- **Width** (int): 图片宽度（像素）
- **Height** (int): 图片高度（像素）
- **UploadTime** (DateTime): 上传时间
- **ViewCount** (int): 浏览次数
- **LikeCount** (int): 点赞数量（冗余字段）
- **CommentCount** (int): 评论数量（冗余字段）
- **SortOrder** (int): 相册内排序顺序
- **索引**: (AlbumId, SortOrder) 用于照片列表查询
- **索引**: (UserId, UploadTime) 用于用户照片查询

#### PhotoTag (照片标签关联表)
- **PhotoId** (long, 外键): 照片 ID
- **TagId** (long, 外键): 标签 ID
- **联合主键**: (PhotoId, TagId)

#### Tag (标签实体 - 复用博客标签)
- **Id** (long, 主键): 标签 ID
- **Name** (string, 50字符): 标签名称
- **UseCount** (int): 使用次数
- **CreateTime** (DateTime): 创建时间

#### PhotoLike (照片点赞实体)
- **Id** (long, 主键): 点赞 ID
- **PhotoId** (long, 外键): 照片 ID
- **UserId** (long, 外键): 点赞用户 ID
- **CreateTime** (DateTime): 点赞时间
- **唯一索引**: (PhotoId, UserId) 防止重复点赞

#### PhotoComment (照片评论实体 - 复用评论系统)
- **Id** (long, 主键): 评论 ID
- **PhotoId** (long, 外键): 照片 ID
- **UserId** (long, 外键): 评论用户 ID
- **Content** (string, 500字符): 评论内容
- **ReplyToId** (long, 可选): 回复的评论 ID
- **ReplyToUserId** (long, 可选): 回复的用户 ID
- **CreateTime** (DateTime): 评论时间
- **索引**: (PhotoId, CreateTime) 用于评论列表查询

## Success Criteria *(mandatory)*

### Measurable Outcomes

- **SC-001**: 照片上传操作在 5 秒内完成（单张 5MB 照片）
- **SC-002**: 相册列表在 500 毫秒内加载完成（50 个相册）
- **SC-003**: 照片网格列表在 1 秒内加载完成（100 张照片）
- **SC-004**: 大图查看器打开响应时间 < 300 毫秒
- **SC-005**: 缩略图生成成功率 > 99%
- **SC-006**: 相册隐私过滤准确率 100%（非授权用户无法访问）
- **SC-007**: 用户上传照片后，50% 以上的照片有描述或标签
- **SC-008**: 用户平均每月创建 3 个以上相册
- **SC-009**: 照片浏览次数增长率 > 30%（相比上线前）
- **SC-010**: 批量操作（删除 20 张照片）在 3 秒内完成

## Assumptions *(optional)*

### Technical Assumptions
- 照片文件存储在云存储服务（如 OSS, S3）或本地文件系统
- 缩略图生成使用服务器端库（如 ImageSharp, Pillow）
- 照片上传使用分块上传（支持大文件和断点续传）
- 大图查看器使用前端库（如 PhotoSwipe, Lightbox2）
- 照片浏览次数使用异步更新（避免阻塞查询）

### Business Assumptions
- 用户平均每月上传 50 张照片
- 大部分相册选择"公开"或"仅好友"（占比 80%）
- 照片主要是 JPG 格式，平均大小 2-5MB
- 用户倾向于按事件或时间创建相册（如"旅行 2025"、"家庭聚会"）

### User Experience Assumptions
- 用户期望照片上传快速（< 5 秒）
- 用户希望照片浏览流畅（无卡顿）
- 用户希望相册支持隐私控制（不是所有照片都公开）
- 用户希望批量操作减少重复劳动

## Dependencies *(optional)*

### Internal Dependencies
- **用户认证与授权系统 (#001)**: 提供用户身份验证
- **用户资料系统 (#002)**: 提供用户头像和用户名
- **好友系统 (#003)**: 提供好友关系数据（隐私过滤）
- **活动动态系统 (#005)**: 生成"上传照片"动态事件
- **评论系统 (#008)**: 复用评论实体和逻辑
- **上传模块 (#012)**: 提供文件上传和存储服务

### External Dependencies
- **云存储服务**: OSS, S3, Azure Blob 用于照片文件存储
- **图片处理库**: ImageSharp (.NET), Pillow (Python) 用于缩略图生成
- **前端图片查看器**: PhotoSwipe, Lightbox2 用于大图浏览
- **ZIP 打包库**: 用于批量下载照片

## Out of Scope *(optional)*

以下功能**不在**本次规格范围内：

- 照片编辑功能（裁剪、滤镜、调色） - 属于高级功能
- 照片人脸识别和自动标注 - 属于 AI 功能
- 照片地理位置地图展示 - 属于扩展功能
- 照片幻灯片播放 - 属于用户体验增强
- 照片打印服务 - 属于商业功能
- 照片水印添加 - 属于版权保护功能
- 照片分享到外部平台（微博、微信） - 属于集成功能
- 照片存储空间配额管理 - 属于资源管理功能

## Notes *(optional)*

### Security Considerations
- 照片文件 URL 应使用签名或临时令牌（防止盗链）
- 相册隐私过滤必须在数据库查询层实现
- 密码保护的相册密码必须加密存储
- 照片上传需要验证文件类型和大小（防止恶意上传）

### Performance Considerations
- 照片列表查询使用复合索引（AlbumId, SortOrder）
- 缩略图生成使用异步任务队列
- 照片浏览次数使用异步更新或缓存
- 相册封面使用缓存（Redis）
- 批量操作使用事务和批量 SQL

### Scalability Considerations
- 照片文件存储使用云存储（分布式存储）
- 照片表按用户 ID 或时间分表
- 缩略图生成使用分布式任务队列（如 Celery, Hangfire）
- 大量照片的相册可以分页加载（虚拟滚动）

### User Experience Considerations
- 照片上传显示实时进度条
- 大图查看器支持键盘和触摸操作
- 照片网格布局自适应（响应式设计）
- 批量操作提供即时反馈（选中数量、操作确认）
- 照片加载失败显示占位图或重试按钮

### Open Questions for Future Iterations
- 是否需要支持照片编辑功能（裁剪、滤镜）？
- 是否需要人脸识别和自动标注？
- 是否需要照片地理位置地图展示？
- 是否需要照片存储空间配额限制？
- 是否需要照片水印功能（版权保护）？
- 批量下载是否需要限制数量（如最多 100 张）？
