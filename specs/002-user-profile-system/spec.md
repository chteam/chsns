# Feature Specification: 用户资料系统

**Feature Branch**: `002-user-profile-system`  
**Created**: 2025-11-13  
**Status**: Draft  
**Input**: 用户资料系统：个人基本信息、联系信息、个人资料展示、头像上传管理、用户积分等级系统、资料编辑

## User Scenarios & Testing *(mandatory)*

### User Story 1 - 查看用户资料 (Priority: P1)

用户可以查看自己和其他用户的公开资料信息，包括基本信息、头像、积分等级、注册时间等。这是社交网络的基础展示功能。

**Why this priority**: 资料展示是用户身份的基础，所有社交互动都需要查看对方资料。这是最基本的社交网络功能。

**Independent Test**: 访问用户主页 URL（如 `/user/123` 或 `/user/username`），验证显示该用户的公开资料信息。

**Acceptance Scenarios**:

1. **Given** 用户访问自己的资料页面, **When** 页面加载, **Then** 显示完整资料（包括私密信息）
2. **Given** 用户访问他人的资料页面, **When** 页面加载, **Then** 仅显示对方公开的资料信息
3. **Given** 用户查看资料, **When** 资料包含头像, **Then** 显示用户上传的头像图片
4. **Given** 用户查看资料, **When** 用户未上传头像, **Then** 显示默认头像
5. **Given** 用户查看资料, **When** 资料包含积分和等级, **Then** 显示当前积分数和对应等级徽章
6. **Given** 访客（未登录）访问用户资料, **When** 页面加载, **Then** 显示公开信息但隐藏需要登录才能查看的内容

---

### User Story 2 - 编辑基本信息 (Priority: P1)

用户可以在账户设置中编辑自己的基本信息，包括真实姓名、性别、生日、所在地等个人资料。

**Why this priority**: 用户需要完善个人资料让其他人了解自己，这是社交网络的核心功能。资料越完整，社交体验越好。

**Independent Test**: 访问资料编辑页面，修改各项信息并保存，验证资料页面显示更新后的内容。

**Acceptance Scenarios**:

1. **Given** 用户在资料编辑页面, **When** 修改真实姓名并保存, **Then** 资料页面显示新的姓名
2. **Given** 用户编辑基本信息, **When** 选择性别（男/女/保密）, **Then** 系统保存性别选择
3. **Given** 用户输入生日, **When** 选择年月日, **Then** 系统计算并显示年龄（可选是否公开）
4. **Given** 用户输入所在地, **When** 填写城市信息, **Then** 资料页显示地理位置
5. **Given** 用户编辑多个字段, **When** 点击保存, **Then** 系统批量更新所有修改的字段
6. **Given** 用户取消编辑, **When** 点击取消按钮, **Then** 系统放弃所有未保存的修改

---

### User Story 3 - 头像上传与管理 (Priority: P1)

用户可以上传自定义头像图片作为个人形象展示。系统支持头像裁剪、预览和删除功能。

**Why this priority**: 头像是用户在社交网络中最直观的身份标识，影响用户的社交形象和互动意愿。

**Independent Test**: 访问头像上传页面，选择图片文件，裁剪后上传，验证资料页显示新头像。

**Acceptance Scenarios**:

1. **Given** 用户在头像上传页面, **When** 选择本地图片文件（JPG/PNG）, **Then** 系统显示图片预览和裁剪工具
2. **Given** 用户上传的图片, **When** 图片尺寸大于 5MB, **Then** 系统提示文件过大并拒绝上传
3. **Given** 用户裁剪图片, **When** 调整裁剪框并确认, **Then** 系统生成多个尺寸的头像（如 48x48, 120x120, 200x200）
4. **Given** 用户上传头像成功, **When** 保存完成, **Then** 系统更新所有使用该用户头像的地方
5. **Given** 用户已有头像, **When** 点击"删除头像", **Then** 系统恢复为默认头像
6. **Given** 用户上传非图片文件, **When** 文件格式错误, **Then** 系统提示"仅支持 JPG/PNG 格式"

---

### User Story 4 - 联系信息管理 (Priority: P2)

用户可以添加和管理联系方式，包括邮箱、个人主页、社交媒体账号等，并设置隐私级别。

**Why this priority**: 联系信息帮助用户扩展社交圈，但需要隐私控制。这是社交网络的重要补充功能。

**Independent Test**: 在联系信息编辑页面添加邮箱、网站等信息，设置可见性，验证不同用户看到的内容符合隐私设置。

**Acceptance Scenarios**:

1. **Given** 用户在联系信息页面, **When** 添加邮箱地址, **Then** 系统验证邮箱格式并保存
2. **Given** 用户添加个人网站, **When** 输入 URL, **Then** 系统验证 URL 格式（必须以 http:// 或 https:// 开头）
3. **Given** 用户设置联系信息可见性, **When** 选择"仅好友可见", **Then** 非好友用户查看资料时看不到该信息
4. **Given** 用户添加多个社交账号, **When** 保存QQ号、微信号、微博等, **Then** 系统在资料页显示对应图标和链接
5. **Given** 用户编辑联系信息, **When** 留空某个字段, **Then** 系统删除该联系方式
6. **Given** 用户设置可见性为"保密", **When** 其他用户查看, **Then** 该联系信息完全隐藏

---

### User Story 5 - 积分与等级系统 (Priority: P2)

系统根据用户活跃度和贡献自动计算积分，积分决定用户等级。用户可以查看自己的积分明细和等级特权。

**Why this priority**: 积分和等级激励用户参与互动，提升社区活跃度。这是社交网络的游戏化机制。

**Independent Test**: 执行产生积分的操作（如发布日志、评论），验证积分增加并在达到阈值时升级。

**Acceptance Scenarios**:

1. **Given** 新用户注册, **When** 账户创建成功, **Then** 系统赋予初始积分（如 100 分）和等级 1
2. **Given** 用户发布内容, **When** 发布日志/照片/评论, **Then** 系统根据内容类型增加积分
3. **Given** 用户获得积分, **When** 总积分达到下一等级阈值, **Then** 系统自动升级并通知用户
4. **Given** 用户查看积分明细, **When** 访问积分记录页面, **Then** 显示积分变动历史（时间、原因、数量）
5. **Given** 用户违规被扣分, **When** 管理员扣除积分, **Then** 系统更新积分和等级（可能降级）
6. **Given** 用户查看等级特权, **When** 访问等级说明页面, **Then** 显示各等级的权限和徽章样式

---

### User Story 6 - 资料隐私设置 (Priority: P2)

用户可以控制个人资料各个字段的可见性，包括公开、好友可见、仅自己可见三个级别。

**Why this priority**: 隐私控制是社交网络的基础需求，用户需要决定哪些信息可以被谁看到。

**Independent Test**: 设置不同字段的隐私级别，用不同身份（自己/好友/陌生人）查看资料，验证可见性符合设置。

**Acceptance Scenarios**:

1. **Given** 用户在隐私设置页面, **When** 设置生日为"仅好友可见", **Then** 非好友用户查看资料时看不到生日
2. **Given** 用户设置手机号为"仅自己可见", **When** 任何其他用户查看, **Then** 手机号完全隐藏
3. **Given** 用户设置头像为"公开", **When** 未登录访客查看, **Then** 可以看到用户头像
4. **Given** 用户批量设置隐私, **When** 选择"所有信息仅好友可见", **Then** 系统更新所有字段的隐私级别
5. **Given** 用户未设置隐私, **When** 首次编辑资料, **Then** 系统使用默认隐私级别（多数字段公开）
6. **Given** 用户修改隐私设置, **When** 保存成功, **Then** 系统立即生效，其他用户查看时看到更新后的可见性

---

### User Story 7 - 查看浏览记录 (Priority: P3)

用户可以查看哪些人访问过自己的资料页面，包括访问时间和次数统计。

**Why this priority**: 浏览记录增加社交网络的互动性，让用户了解谁关注自己，但不是核心功能。

**Independent Test**: 用另一个账户访问用户资料，验证被访问用户的浏览记录中显示该访客和访问时间。

**Acceptance Scenarios**:

1. **Given** 用户 A 访问用户 B 的资料, **When** 页面加载完成, **Then** 系统记录用户 A 的访问（时间、用户 ID）
2. **Given** 用户查看自己的浏览记录, **When** 访问"谁看过我"页面, **Then** 显示最近访客列表（头像、用户名、访问时间）
3. **Given** 用户多次访问同一资料, **When** 24 小时内重复访问, **Then** 系统仅记录一次（避免刷数据）
4. **Given** 用户设置隐私, **When** 开启"匿名访问"模式, **Then** 访问他人资料时不留下访问记录
5. **Given** 浏览记录过多, **When** 超过保留期限（如 30 天）, **Then** 系统自动清理旧记录
6. **Given** 用户查看访客, **When** 点击访客头像, **Then** 跳转到该访客的资料页面

---

### Edge Cases

- **并发编辑**: 用户在多个设备同时编辑资料，系统必须处理冲突（最后写入胜出）
- **头像上传失败**: 文件上传过程中网络中断，系统应允许重试而不是留下损坏的文件
- **大图片上传**: 用户上传超大图片（如 20MB），系统应在客户端压缩或拒绝上传
- **积分计算错误**: 系统异常导致积分重复增加，需要去重和回滚机制
- **隐私设置不一致**: 用户修改隐私设置时数据库更新失败，可能导致部分字段设置不生效
- **头像缓存问题**: 用户更新头像后，其他用户因浏览器缓存仍看到旧头像
- **敏感信息泄露**: 用户误设置敏感信息为公开，需要提供醒目的隐私提示
- **访客记录隐私**: 匿名访问功能被滥用用于跟踪，需要平衡隐私和功能
- **等级降级**: 用户因违规被扣分后降级，需要处理等级特权的撤销

## Requirements *(mandatory)*

### Functional Requirements

#### 资料展示
- **FR-001**: 系统 MUST 为每个用户提供唯一的资料页面 URL（支持 `/user/{userId}` 和 `/user/{username}` 两种格式）
- **FR-002**: 资料页面 MUST 显示用户头像、用户名、真实姓名（如果公开）、积分、等级、注册时间
- **FR-003**: 用户查看自己的资料时 MUST 显示所有字段（包括私密信息）
- **FR-004**: 用户查看他人资料时 MUST 根据隐私设置过滤字段
- **FR-005**: 未登录访客 MUST 只能查看公开资料，无法看到需要登录的内容
- **FR-006**: 资料页面 MUST 显示用户的最近活动摘要（如最新日志、最新照片）

#### 基本信息编辑
- **FR-007**: 用户 MUST 能够编辑以下基本信息：真实姓名、性别、生日、所在地、家乡、个人简介
- **FR-008**: 真实姓名 MUST 支持中英文和符号，最大长度 50 字符
- **FR-009**: 性别 MUST 支持三个选项：男、女、保密（默认保密）
- **FR-010**: 生日 MUST 使用日期选择器，格式为 YYYY-MM-DD
- **FR-011**: 系统 SHOULD 根据生日自动计算年龄，用户可选择是否公开年龄
- **FR-012**: 个人简介 MUST 支持多行文本，最大长度 500 字符
- **FR-013**: 所有编辑操作 MUST 实时验证输入格式，错误时显示提示

#### 头像管理
- **FR-014**: 系统 MUST 支持用户上传头像图片，格式限制为 JPG、PNG、GIF
- **FR-015**: 头像文件大小 MUST 限制在 5MB 以内
- **FR-016**: 系统 MUST 提供图片裁剪工具，强制裁剪为正方形
- **FR-017**: 系统 MUST 生成多个尺寸的头像缩略图：48x48（小头像）、120x120（中头像）、200x200（大头像）
- **FR-018**: 头像上传成功后 MUST 立即在资料页显示新头像
- **FR-019**: 用户 MUST 能够删除自定义头像并恢复为默认头像
- **FR-020**: 默认头像 MUST 根据用户 ID 生成唯一的几何图案或颜色（如 Identicon）
- **FR-021**: 头像图片 MUST 存储在独立的存储服务（文件系统或云存储）

#### 联系信息
- **FR-022**: 用户 MUST 能够添加以下联系方式：邮箱、手机号、QQ号、微信号、个人网站、微博、GitHub
- **FR-023**: 邮箱 MUST 验证格式（正则表达式），手机号 MUST 验证中国大陆格式（可选）
- **FR-024**: 个人网站 MUST 验证 URL 格式，必须以 `http://` 或 `https://` 开头
- **FR-025**: 每个联系方式 MUST 支持独立的隐私设置（公开/好友可见/仅自己）
- **FR-026**: 联系信息在资料页 MUST 以图标形式展示，点击跳转或复制
- **FR-027**: 用户删除联系信息时 MUST 从数据库中移除，而非仅隐藏

#### 积分与等级
- **FR-028**: 系统 MUST 为每个用户维护积分（Score）和展示积分（ShowScore）两个字段
- **FR-029**: 展示积分 MUST 用于排名和等级计算，实际积分用于扣分惩罚
- **FR-030**: 积分规则：注册 +100、发布日志 +10、上传照片 +5、发表评论 +2、被点赞 +1、违规扣分 -50
- **FR-031**: 等级 MUST 根据展示积分自动计算：1级（0-100）、2级（101-500）、3级（501-1000）、4级（1001-2000）、5级（2000+）
- **FR-032**: 用户升级时 MUST 显示通知消息（如"恭喜升级到 3 级"）
- **FR-033**: 用户 MUST 能够查看积分明细记录（时间、事件、积分变化）
- **FR-034**: 系统 MUST 记录积分变动日志供审计和回滚

#### 隐私设置
- **FR-035**: 每个资料字段 MUST 支持三种隐私级别：公开（0）、好友可见（1）、仅自己（2）
- **FR-036**: 隐私级别存储在 ShowLevel 字段（byte 类型）
- **FR-037**: 默认隐私级别：头像、用户名、注册时间为公开，其他字段为好友可见
- **FR-038**: 用户 MUST 能够批量设置所有字段的隐私级别
- **FR-039**: 系统 MUST 在数据查询时根据当前用户身份过滤字段（SQL 查询或应用层过滤）
- **FR-040**: 隐私设置修改 MUST 立即生效，无需刷新页面

#### 浏览记录
- **FR-041**: 系统 MUST 记录用户资料页的访问记录（访客 ID、被访问用户 ID、访问时间）
- **FR-042**: 同一用户 24 小时内多次访问 MUST 只记录一次
- **FR-043**: 用户 MUST 能够查看最近 30 天的访客列表
- **FR-044**: 用户 MUST 能够开启"匿名访问"模式，此模式下不留下访问记录
- **FR-045**: 浏览记录 MUST 在 30 天后自动清理（或归档到历史表）
- **FR-046**: 资料页 MUST 显示总浏览次数（ViewCount）

### Key Entities

#### Profile (用户资料实体)
- **UserId** (long, 主键, 外键到 Account): 用户唯一标识
- **AccountType** (byte): 账户类型（0=普通用户, 1=认证用户, 2=管理员）
- **Name** (string, 50字符): 真实姓名
- **Face** (string): 头像 URL 路径
- **Score** (long): 实际积分（用于扣分）
- **ShowScore** (long): 展示积分（用于排名和等级）
- **DelScore** (long): 累计被扣除的积分
- **ShowLevel** (byte): 资料整体隐私级别（0=公开, 1=好友, 2=私密）
- **RegTime** (DateTime): 注册时间（只读）
- **LoginTime** (DateTime): 最后登录时间
- **ViewCount** (long): 资料页浏览次数
- **FileSizeAll** (long): 用户文件总大小（字节）
- **FileSizeCount** (long): 用户文件数量
- **Applications** (string): 已安装的应用列表（JSON 或逗号分隔）
- **Applicationlist** (string): 应用配置
- **Status** (byte): 账户状态（0=正常, 1=冻结, 2=禁用）

#### BasicInformation (基本信息)
- **UserId** (long, 主键, 外键): 关联用户
- **RealName** (string): 真实姓名
- **Gender** (byte): 性别（0=保密, 1=男, 2=女）
- **Birthday** (DateTime, 可选): 生日
- **Hometown** (string): 家乡
- **Location** (string): 现居地
- **Bio** (string, 500字符): 个人简介
- **ShowAge** (bool): 是否公开年龄
- **ShowLevel** (byte): 隐私级别

#### ContactInformation (联系信息)
- **UserId** (long, 主键, 外键): 关联用户
- **Email** (string): 邮箱
- **Phone** (string): 手机号
- **QQ** (string): QQ号
- **WeChat** (string): 微信号
- **Website** (string): 个人网站
- **Weibo** (string): 微博地址
- **GitHub** (string): GitHub 用户名
- **EmailShowLevel** (byte): 邮箱隐私级别
- **PhoneShowLevel** (byte): 手机隐私级别
- **QQShowLevel** (byte): QQ隐私级别
- **WeChatShowLevel** (byte): 微信隐私级别
- **WebsiteShowLevel** (byte): 网站隐私级别

#### ScoreLog (积分日志)
- **Id** (long, 主键): 日志 ID
- **UserId** (long, 外键): 关联用户
- **EventType** (enum): 事件类型（Register, PublishNote, UploadPhoto, Comment, Like, Penalty）
- **ScoreChange** (int): 积分变化（可为负数）
- **CurrentScore** (long): 操作后的总积分
- **Reason** (string): 变动原因
- **CreatedAt** (DateTime): 发生时间

#### ViewLog (浏览记录)
- **Id** (long, 主键): 记录 ID
- **VisitorId** (long, 外键): 访客用户 ID（可选，未登录为 null）
- **TargetUserId** (long, 外键): 被访问用户 ID
- **IpAddress** (string): 访客 IP 地址
- **CreatedAt** (DateTime): 访问时间
- **唯一约束**: (VisitorId, TargetUserId, Date(CreatedAt)) 防止 24 小时内重复记录

#### FieldInformation (字段信息 - 用于扩展字段)
- **Id** (long, 主键): 字段 ID
- **UserId** (long, 外键): 关联用户
- **FieldName** (string): 字段名称（如"学校"、"职业"）
- **FieldValue** (string): 字段值
- **ShowLevel** (byte): 隐私级别
- **Order** (int): 显示顺序

## Success Criteria *(mandatory)*

### Measurable Outcomes

- **SC-001**: 用户资料页面在 1 秒内加载完成（包括头像和基本信息）
- **SC-002**: 头像上传和裁剪流程在 10 秒内完成（5MB 图片）
- **SC-003**: 用户可以在 2 分钟内完成基本资料的首次填写
- **SC-004**: 隐私设置修改后立即生效，其他用户查看资料时实时过滤字段
- **SC-005**: 积分计算准确率 100%，不出现重复计算或遗漏
- **SC-006**: 系统支持 500 个并发用户同时编辑资料不出现冲突
- **SC-007**: 头像缓存策略生效，用户更新头像后 5 秒内全站刷新
- **SC-008**: 浏览记录查询在 500 毫秒内返回最近 30 天的访客列表
- **SC-009**: 用户资料完整度达到 60% 以上时，社交互动率提升 40%
- **SC-010**: 图片上传失败率低于 1%（排除网络异常）
- **SC-011**: 隐私设置覆盖率 100%，所有资料字段都可以设置隐私级别
- **SC-012**: 等级系统激励有效，80% 的活跃用户在 3 个月内达到 2 级以上

## Assumptions *(optional)*

### Technical Assumptions
- 头像存储使用本地文件系统（默认）或云存储服务（如 AWS S3、阿里云 OSS）
- 图片裁剪和缩放在客户端完成（使用 Canvas API），减少服务器负载
- 积分计算通过数据库触发器或应用层事件监听器实现
- 浏览记录使用独立表存储，避免影响 Profile 表性能

### Business Assumptions
- 用户默认希望展示自己的资料给好友，而非完全公开或完全私密
- 积分和等级是激励机制，不涉及付费或虚拟货币交易
- 用户对头像的要求是方形，不支持异形裁剪（如圆形、心形）
- 浏览记录保留 30 天足够满足用户需求，不需要永久存储

### User Experience Assumptions
- 用户期望资料编辑是即时保存，而非整个表单提交
- 用户希望看到头像上传的进度条和预览
- 用户对隐私设置的理解程度不一，需要提供清晰的说明和示例
- 用户期望浏览记录功能但不希望被滥用（如跟踪骚扰）

## Dependencies *(optional)*

### Internal Dependencies
- **用户认证与授权系统 (#001)**: 必须先完成，提供 UserId 和认证机制
- 好友系统（未来）: 隐私设置中的"好友可见"需要好友关系数据
- 内容系统（日志、照片）: 积分规则依赖内容发布事件

### External Dependencies
- **图片处理库**: 用于生成缩略图（如 ImageSharp for .NET）
- **文件存储服务**: 本地文件系统或云存储（S3, OSS）
- **数据库**: 支持事务和唯一约束的关系型数据库

### Future Dependencies
- 好友系统将依赖此功能的隐私设置
- 消息系统将使用用户头像和基本信息
- 动态流将显示用户资料摘要

## Out of Scope *(optional)*

以下功能**不在**本次规格范围内，将在后续功能中实现：

- 邮箱验证和手机号验证 - 属于账户安全增强功能
- 用户勋章系统 - 属于游戏化扩展功能
- 用户认证徽章（蓝V） - 属于高级用户功能
- 资料背景图/封面图 - 属于个性化扩展功能
- 第三方社交账号展示（如 Twitter、Instagram） - 属于集成功能
- 用户兴趣标签和推荐 - 属于推荐系统功能
- 资料修改历史记录 - 属于审计功能
- 黑名单管理（屏蔽访客） - 属于隐私增强功能
- 导出用户数据（GDPR 合规） - 属于合规功能

## Notes *(optional)*

### Security Considerations
- 头像上传需要验证文件类型（魔术字节），防止上传恶意文件
- 隐私设置必须在数据库查询层面强制执行，不能仅依赖前端隐藏
- 浏览记录需要防止爬虫和自动化工具滥用
- 积分系统需要防刷机制，避免用户通过脚本刷分

### Performance Considerations
- 头像使用 CDN 加速，减少服务器带宽压力
- 资料页面查询应使用数据库索引优化（UserId, UserName）
- 浏览记录查询应使用时间范围索引（CreatedAt + TargetUserId）
- 积分计算可以异步处理，避免阻塞用户操作

### Scalability Considerations
- 头像存储应支持分布式存储，避免单点故障
- 积分日志可以分表存储（按月或按用户 ID 哈希）
- 浏览记录可以使用消息队列异步写入，减少实时压力

### User Experience Considerations
- 资料编辑表单应支持自动保存草稿，避免用户误操作丢失
- 头像上传应提供实时进度反馈和错误提示
- 隐私设置应有可视化示例（如"好友看到的样子"预览）
- 积分变化应有动画效果和通知提醒，增强激励感

### Open Questions for Future Iterations
- 是否需要支持视频头像或动态 GIF 头像？
- 是否需要支持用户自定义资料字段（如"星座"、"血型"）？
- 积分规则是否需要可配置（管理员调整）？
- 是否需要支持资料页面的自定义模板或主题？
- 是否需要支持用户资料的导入/导出（迁移到其他平台）？
