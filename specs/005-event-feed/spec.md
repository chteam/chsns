# Feature Specification: 活动动态系统

**Feature Branch**: `005-event-feed`  
**Created**: 2025-11-14  
**Status**: Draft  
**Input**: 活动动态系统：用户动态时间线、好友动态Feed、事件类型（发博客、上传照片、加好友等）、动态点赞评论、动态隐私设置

## User Scenarios & Testing *(mandatory)*

### User Story 1 - 查看个人动态时间线 (Priority: P1)

用户可以查看自己的所有活动记录（时间线），包括发布内容、社交互动、系统事件等。

**Why this priority**: 个人时间线是用户自我回顾和管理活动历史的核心功能，帮助用户了解自己的行为轨迹。

**Independent Test**: 用户访问个人主页，查看自己过去 30 天内的所有动态（发博客、上传照片、添加好友等）。

**Acceptance Scenarios**:

1. **Given** 用户访问个人主页, **When** 页面加载, **Then** 显示按时间倒序的动态列表
2. **Given** 用户发布一篇博客, **When** 博客保存成功, **Then** 个人时间线立即显示"发布了新博客"事件
3. **Given** 用户上传照片到相册, **When** 照片上传完成, **Then** 时间线显示"上传了 N 张照片"事件
4. **Given** 用户添加新好友, **When** 好友关系建立, **Then** 时间线显示"添加了新好友 XXX"事件
5. **Given** 用户查看时间线, **When** 有多种事件类型, **Then** 每个事件显示对应的图标和描述
6. **Given** 用户时间线有 100+ 条动态, **When** 滚动到底部, **Then** 自动加载更多历史动态（分页）

---

### User Story 2 - 查看好友动态 Feed (Priority: P1)

用户可以查看好友的最新动态，类似社交网络的"首页信息流"，按时间倒序展示。

**Why this priority**: 好友动态 Feed 是 SNS 应用的核心，帮助用户保持与朋友的联系和互动。

**Independent Test**: 用户登录后访问首页，看到所有好友过去 24 小时的动态（按时间排序）。

**Acceptance Scenarios**:

1. **Given** 用户访问首页 Feed, **When** 页面加载, **Then** 显示所有好友的最新动态（按时间倒序）
2. **Given** 好友 A 发布博客, **When** 用户刷新 Feed, **Then** Feed 顶部显示"A 发布了新博客"
3. **Given** 好友 B 上传照片, **When** 用户查看 Feed, **Then** 显示"B 上传了 5 张照片"并展示缩略图
4. **Given** 用户有 100 个好友, **When** 查看 Feed, **Then** 仅显示最近 7 天内的动态（性能优化）
5. **Given** 用户 Feed 有 50+ 条动态, **When** 滚动到底部, **Then** 自动加载更多动态
6. **Given** 好友设置动态为"仅自己可见", **When** 用户查看 Feed, **Then** 该动态不显示在 Feed 中

---

### User Story 3 - 支持多种事件类型 (Priority: P1)

系统需要支持多种用户行为产生的动态事件，每种事件有对应的图标、描述和关联内容。

**Why this priority**: 丰富的事件类型让时间线和 Feed 更生动，反映用户的多样化活动。

**Independent Test**: 系统正确记录并显示以下事件：发博客、发评论、上传照片、创建相册、添加好友、加入群组、参与活动。

**Acceptance Scenarios**:

1. **Given** 系统支持"发布博客"事件, **When** 用户发布博客, **Then** 事件包含博客标题和摘要
2. **Given** 系统支持"上传照片"事件, **When** 用户上传多张照片, **Then** 事件显示照片数量和缩略图
3. **Given** 系统支持"添加好友"事件, **When** 用户添加好友, **Then** 事件显示好友头像和用户名
4. **Given** 系统支持"加入群组"事件, **When** 用户加入群组, **Then** 事件显示群组名称和图标
5. **Given** 系统支持"更新资料"事件, **When** 用户修改个人资料, **Then** 事件显示"更新了个人资料"
6. **Given** 系统需要扩展新事件类型, **When** 添加"分享文章"事件, **Then** 系统可灵活支持（枚举扩展）

---

### User Story 4 - 动态点赞 (Priority: P2)

用户可以对动态点赞，表达认可和支持。点赞数量实时更新。

**Why this priority**: 点赞是社交互动的基础功能，增强用户参与感和社区活跃度。

**Independent Test**: 用户点击好友动态的"点赞"按钮，验证点赞数量增加，再次点击取消点赞。

**Acceptance Scenarios**:

1. **Given** 用户查看动态, **When** 点击"点赞"按钮, **Then** 点赞数量 +1 且按钮变为"已点赞"状态
2. **Given** 用户已点赞, **When** 再次点击"取消点赞", **Then** 点赞数量 -1 且按钮恢复为"点赞"
3. **Given** 多个用户点赞同一动态, **When** 查看点赞列表, **Then** 显示所有点赞用户的头像和用户名
4. **Given** 用户点赞动态, **When** 动态作者查看, **Then** 作者收到点赞通知（可选）
5. **Given** 用户点赞自己的动态, **When** 系统处理, **Then** 允许点赞但可能提示"你点赞了自己的动态"

---

### User Story 5 - 动态评论 (Priority: P2)

用户可以对动态发表评论，与好友互动。评论支持嵌套回复。

**Why this priority**: 评论是深度互动的方式，让用户可以表达观点和讨论。

**Independent Test**: 用户在好友动态下发表评论，验证评论显示在动态下方，支持回复他人评论。

**Acceptance Scenarios**:

1. **Given** 用户查看动态, **When** 在评论框输入文字并发表, **Then** 评论立即显示在动态下方
2. **Given** 用户发表评论, **When** 评论内容超过 500 字符, **Then** 系统提示"评论过长"
3. **Given** 用户点击"回复"按钮, **When** 输入回复内容, **Then** 评论显示"@被回复人: 回复内容"
4. **Given** 动态有 20+ 条评论, **When** 页面加载, **Then** 默认显示前 10 条，其他可展开查看
5. **Given** 用户删除自己的评论, **When** 确认删除, **Then** 评论从动态中移除
6. **Given** 动态作者删除他人评论, **When** 确认删除, **Then** 评论被移除（管理权限）

---

### User Story 6 - 动态隐私设置 (Priority: P1)

用户可以为每条动态设置隐私级别（公开、仅好友、仅自己），控制谁可以查看。

**Why this priority**: 隐私控制是用户对个人信息管理的核心需求，增强安全感和控制感。

**Independent Test**: 用户发布动态时选择"仅好友可见"，验证非好友无法在 Feed 或个人主页看到该动态。

**Acceptance Scenarios**:

1. **Given** 用户发布动态, **When** 选择隐私级别"公开", **Then** 所有人可以在用户主页查看该动态
2. **Given** 用户发布动态, **When** 选择隐私级别"仅好友", **Then** 仅好友在 Feed 和主页看到该动态
3. **Given** 用户发布动态, **When** 选择隐私级别"仅自己", **Then** 仅用户本人在个人时间线看到
4. **Given** 用户修改已发布动态的隐私, **When** 从"公开"改为"仅好友", **Then** 非好友立即无法查看
5. **Given** 用户设置默认隐私级别, **When** 发布新动态, **Then** 自动应用默认隐私设置
6. **Given** 系统管理员查看动态, **When** 动态为"仅自己", **Then** 管理员可以查看（审计需求）

---

### Edge Cases

- **批量动态生成**: 用户一次性上传 100 张照片，系统应合并为一条动态而非 100 条
- **动态时间戳**: 用户时区不同，时间线应显示本地时间
- **动态删除关联**: 用户删除博客后，对应的动态应同步删除或标记为"内容已删除"
- **隐私冲突**: 用户 A 发布"与 B 成为好友"动态，但 B 设置为隐私，应如何处理
- **点赞/评论权限**: 动态为"仅好友可见"，非好友是否可以点赞/评论（通过直接链接访问）
- **动态去重**: 用户短时间内多次执行相同操作（如连续添加 3 个好友），是否合并为一条动态
- **Feed 性能**: 用户有 1000 个好友，查询 Feed 时如何优化性能
- **事件顺序**: 用户发布博客后立即删除，动态是否应显示

## Requirements *(mandatory)*

### Functional Requirements

#### 个人时间线
- **FR-001**: 用户 MUST 能够查看自己的所有活动记录（个人时间线）
- **FR-002**: 个人时间线 MUST 按时间倒序排列（最新的在最前）
- **FR-003**: 个人时间线 MUST 支持分页或无限滚动，每页显示 20 条动态
- **FR-004**: 个人时间线 MUST 显示每条动态的类型、时间、关联内容摘要
- **FR-005**: 用户 MUST 能够查看自己的历史动态（至少保留 1 年）

#### 好友动态 Feed
- **FR-006**: 用户 MUST 能够查看所有好友的最新动态（Feed）
- **FR-007**: Feed MUST 按时间倒序排列（最新的在最前）
- **FR-008**: Feed MUST 仅显示"公开"或"仅好友"的动态（隐私过滤）
- **FR-009**: Feed MUST 支持分页或无限滚动，每页显示 20 条动态
- **FR-010**: Feed MUST 优化查询性能，响应时间 < 1 秒（100 个好友场景）
- **FR-011**: Feed SHOULD 支持"仅看某人"过滤（点击用户名查看该用户的动态）

#### 事件类型
- **FR-012**: 系统 MUST 支持以下事件类型：
  - 发布博客 (PublishBlog)
  - 发表评论 (PostComment)
  - 上传照片 (UploadPhoto)
  - 创建相册 (CreateAlbum)
  - 添加好友 (AddFriend)
  - 加入群组 (JoinGroup)
  - 更新资料 (UpdateProfile)
  - 参与活动 (JoinEvent)
- **FR-013**: 每种事件类型 MUST 包含：事件名称、图标、描述模板、关联对象 ID
- **FR-014**: 系统 MUST 支持灵活扩展新事件类型（枚举或配置表）
- **FR-015**: 事件 MUST 记录发生时间（CreateTime）和用户 ID（UserId）

#### 动态内容
- **FR-016**: 动态 MUST 显示事件类型对应的描述（如"张三发布了新博客《标题》"）
- **FR-017**: 动态 MUST 支持富文本摘要（如博客前 100 字）
- **FR-018**: 动态 MUST 显示关联内容的缩略图（如照片缩略图、博客封面）
- **FR-019**: 动态 MUST 支持点击跳转到关联内容详情页

#### 动态点赞
- **FR-020**: 用户 MUST 能够对动态点赞
- **FR-021**: 用户 MUST 能够取消点赞
- **FR-022**: 系统 MUST 实时更新点赞数量
- **FR-023**: 系统 MUST 记录点赞用户列表（用于显示"谁点赞了"）
- **FR-024**: 用户 MUST 能够查看点赞用户列表（点击点赞数量）
- **FR-025**: 用户 SHOULD 收到点赞通知（可选，集成通知系统）

#### 动态评论
- **FR-026**: 用户 MUST 能够对动态发表评论
- **FR-027**: 评论 MUST 限制在 500 字符以内
- **FR-028**: 评论 MUST 支持嵌套回复（@用户名）
- **FR-029**: 评论 MUST 显示评论人头像、用户名、时间
- **FR-030**: 用户 MUST 能够删除自己的评论
- **FR-031**: 动态作者 MUST 能够删除他人在自己动态下的评论
- **FR-032**: 评论列表 MUST 按时间正序排列（最早的在最前）
- **FR-033**: 评论 SHOULD 支持分页，默认显示最新 10 条

#### 动态隐私
- **FR-034**: 用户 MUST 能够为每条动态设置隐私级别：公开（Public）、仅好友（FriendsOnly）、仅自己（Private）
- **FR-035**: 隐私级别"公开" MUST 允许所有人查看（包括游客）
- **FR-036**: 隐私级别"仅好友" MUST 仅允许好友查看
- **FR-037**: 隐私级别"仅自己" MUST 仅允许用户本人查看
- **FR-038**: 用户 MUST 能够修改已发布动态的隐私级别
- **FR-039**: 用户 SHOULD 能够设置默认隐私级别（应用到未来所有动态）

#### 动态管理
- **FR-040**: 用户 MUST 能够删除自己的动态
- **FR-041**: 删除动态时 MUST 同时删除关联的点赞和评论记录
- **FR-042**: 系统 SHOULD 在关联内容删除时同步删除或更新动态（如博客删除后，动态标记为"内容已删除"）
- **FR-043**: 系统 MUST 防止重复动态（如短时间内连续添加多个好友，合并为一条动态）

### Key Entities

#### EventLog (活动动态实体)
- **Id** (long, 主键): 动态 ID
- **UserId** (long, 外键): 用户 ID（动态发起人）
- **EventType** (enum/string): 事件类型（PublishBlog, UploadPhoto, AddFriend 等）
- **RelatedId** (long, 可选): 关联对象 ID（如博客 ID、照片 ID）
- **Title** (string, 200字符): 动态标题或描述
- **Body** (string, 1000字符): 动态详情或摘要
- **CreateTime** (DateTime): 动态创建时间
- **Privacy** (enum): 隐私级别（Public=0, FriendsOnly=1, Private=2）
- **LikeCount** (int): 点赞数量（冗余字段，性能优化）
- **CommentCount** (int): 评论数量（冗余字段，性能优化）
- **索引**: (UserId, CreateTime) 用于个人时间线查询
- **索引**: (CreateTime, Privacy) 用于 Feed 查询

#### EventLike (动态点赞实体)
- **Id** (long, 主键): 点赞 ID
- **EventId** (long, 外键): 动态 ID
- **UserId** (long, 外键): 点赞用户 ID
- **CreateTime** (DateTime): 点赞时间
- **唯一索引**: (EventId, UserId) 防止重复点赞

#### EventComment (动态评论实体)
- **Id** (long, 主键): 评论 ID
- **EventId** (long, 外键): 动态 ID
- **UserId** (long, 外键): 评论用户 ID
- **Content** (string, 500字符): 评论内容
- **ReplyToId** (long, 可选): 回复的评论 ID（嵌套回复）
- **ReplyToUserId** (long, 可选): 回复的用户 ID
- **CreateTime** (DateTime): 评论时间
- **索引**: (EventId, CreateTime) 用于评论列表查询

## Success Criteria *(mandatory)*

### Measurable Outcomes

- **SC-001**: 用户个人时间线在 500 毫秒内加载完成（50 条动态）
- **SC-002**: 好友动态 Feed 在 1 秒内加载完成（100 个好友，200 条动态）
- **SC-003**: 点赞操作响应时间 < 300 毫秒
- **SC-004**: 评论发表响应时间 < 500 毫秒
- **SC-005**: 隐私过滤准确率 100%（非好友无法查看"仅好友"动态）
- **SC-006**: 系统支持 1000 个并发用户查看 Feed 不出现性能问题
- **SC-007**: Feed 刷新率提升 50%（用户更频繁查看首页）
- **SC-008**: 动态点赞率 > 20%（至少 20% 的动态被点赞）
- **SC-009**: 动态评论率 > 10%（至少 10% 的动态有评论）
- **SC-010**: 用户日均查看 Feed 次数 > 5 次

## Assumptions *(optional)*

### Technical Assumptions
- Feed 查询使用缓存（Redis）优化性能
- 动态按时间分表（如按月）减少单表数据量
- 点赞和评论数量使用冗余字段（实时更新或定时同步）
- 事件类型使用枚举或配置表存储

### Business Assumptions
- 用户平均有 50 个好友
- 用户每天产生 3-5 条动态
- Feed 主要显示最近 7 天内的动态
- 历史动态保留 1 年后可归档

### User Experience Assumptions
- 用户期望 Feed 实时更新（或准实时，延迟 < 30 秒）
- 用户希望看到好友的重要动态（如发博客、上传照片）
- 用户不希望被垃圾动态打扰（需要智能过滤）
- 用户希望控制自己的动态隐私

## Dependencies *(optional)*

### Internal Dependencies
- **用户认证与授权系统 (#001)**: 提供用户身份验证
- **用户资料系统 (#002)**: 提供用户头像和用户名
- **好友系统 (#003)**: 提供好友关系数据（Feed 查询）
- **博客系统 (#006)**: 提供博客事件和内容
- **相册/照片系统 (#007)**: 提供照片事件和内容
- **评论系统 (#008)**: 复用评论实体和逻辑（或独立实现）
- 通知系统（未来）: 集成点赞和评论通知

### External Dependencies
- **数据库**: 支持高效的时间范围查询和多表 JOIN
- **缓存服务**: Redis 用于 Feed 缓存
- **消息队列**: 异步生成动态事件（如博客发布后触发）

## Out of Scope *(optional)*

以下功能**不在**本次规格范围内：

- 动态置顶功能 - 属于用户体验优化
- 动态分享到外部平台（微博、微信） - 属于集成功能
- 动态标签或话题 - 属于内容组织功能
- 智能推荐算法（非好友的热门动态） - 属于算法优化
- 动态表情回复（除了点赞和评论） - 属于互动增强
- 动态统计分析（查看谁访问了我的主页） - 属于数据分析
- 动态草稿保存 - 属于用户体验优化
- 动态多媒体嵌入（视频、音频） - 属于扩展功能

## Notes *(optional)*

### Security Considerations
- 隐私过滤必须在数据库查询层实现，防止绕过
- 评论内容需要防止 XSS 攻击（HTML 转义）
- 点赞和评论需要防止刷量（速率限制）
- 动态删除需要级联删除关联数据

### Performance Considerations
- Feed 查询使用复合索引（CreateTime, Privacy）
- Feed 数据使用 Redis 缓存，TTL 5 分钟
- 点赞和评论数量使用冗余字段，异步更新
- 动态列表分页减少数据传输量
- 历史动态按时间分表（如按月）

### Scalability Considerations
- 动态表按时间分表（按月或按季度）
- Feed 生成使用推模式（发布时推送给所有好友）或拉模式（查询时拉取）
- 高频用户（如网红）的动态可以单独缓存
- 点赞和评论表按 EventId 分片

### User Experience Considerations
- Feed 页面支持下拉刷新（移动端）
- 动态加载使用骨架屏提升体验
- 点赞和评论操作提供即时反馈（乐观更新）
- 动态内容支持富文本预览（如博客摘要、照片缩略图）

### Open Questions for Future Iterations
- 是否需要支持动态置顶功能？
- 是否需要智能推荐算法（非好友的热门动态）？
- 是否需要支持动态标签或话题？
- 是否需要支持动态分享到外部平台？
- Feed 生成使用推模式还是拉模式？（影响架构设计）
- 如何处理高频用户（如网红）的动态（性能优化）？
